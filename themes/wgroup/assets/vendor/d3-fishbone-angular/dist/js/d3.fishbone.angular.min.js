/*!
 * =============================================================
 * d3.fishbone v0.1.0 - This is a Fishbone or Ishikawa diagram, which shows contributions of different levels of a hierarchy to a main concept.
 * https://gist.github.com/bollwyvl/9239214
 *
 * (c) 2016 - Nicholas Bollweg (http://bl.ocks.org/bollwyvl/9239214)
 * =============================================================
 */

!function(t,n){"function"==typeof define&&define.amd?define(["angular","d3"],n):n(t.angular,t.d3)}(this,function(t,n){"use strict";return t.module("fishbone",[]).directive("fishbone",function(){return{restrict:"AE",require:"ngModel",transclude:!0,scope:{fishboneConfig:"="},link:function(t,e,r,o){function i(t){d.datum(t).call(u.defaultArrow).call(u),u.force().size([l().width,l().height]).start(),d.attr(l())}try{}catch(c){throw new Error("d3.js not loaded.")}var a=e[0];t.$watch(function(){return o.$modelValue},function(t){console.log(t),t&&(0===Object.keys(t).length&&t.constructor===Object||i(t))});var u=n.fishbone(),l=function(){return{width:a.clientWidth,height:a.clientHeight}},d=n.select(a).append("svg");n.select(window).on("resize",function(){u.force().size([l().width,l().height]).start(),d.attr(l())}),t.fishbone=u}}})}),function(t){"use strict";t.fishbone=function(){function n(t){var n=t.selectAll("defs").data([1]);n.enter().append("defs"),n.selectAll("marker#"+f()).data([1]).enter().append("marker").attr({id:f(),viewBox:"0 -5 10 10",refX:10,refY:0,markerWidth:10,markerHeight:10,orient:"auto"}).append("path").attr({d:"M0,-5L10,0L0,5"})}function e(t){a.push(t);var n,r,o=0,i=[t,t.connector],c=[{source:t,target:t.connector,arrow:!0,depth:t.depth||0}];return t.parent?(t.connector.maxChildIdx=0,t.connector.totalLinks=[]):(a.push(n={tail:!0}),i=[n,t],c[0].source=n,c[0].target=t,t.horizontal=!0,t.vertical=!1,t.depth=0,t.root=!0,t.totalLinks=[]),t.linkCount=1,(p(t)||[]).forEach(function(u,l){u.parent=t,u.depth=(t.depth||0)+1,u.childIdx=l,u.region=t.region?t.region:1&l?1:-1,u.horizontal=!t.horizontal,u.vertical=!t.vertical,t.root&&n&&!n.tail?(a.push(u.connector={between:i,childIdx:n.childIdx}),n=null):a.push(n=u.connector={between:i,childIdx:o++}),c.push({source:u,target:u.connector,depth:u.depth}),r=e(u),t.linkCount+=r,i[1].totalLinks.push(r)}),i[1].maxChildIdx=o,Array.prototype.unshift.apply(u,c),t.linkCount}function r(t){t.attr({x1:function(t){return t.source.x},y1:function(t){return t.source.y},x2:function(t){return t.target.x},y2:function(t){return t.target.y}})}function o(t){t.attr("transform",function(t){return"translate("+t.x+","+t.y+")"})}function i(t){return(t.target.maxChildIdx+1)*m(t.depth+1)}function c(t){var n,e,i=6*t.alpha,c=w.size(),u=c[0],f=c[1];a.forEach(function(t){t.root&&(t.x=u-(s+h.getBBox().width)),t.tail&&(t.x=s,t.y=f/2),1===t.depth&&(t.y=-1===t.region?s:f-s,t.x-=10*i),t.vertical&&(t.y+=i*t.region),t.depth&&(t.x-=i),t.between&&(n=t.between[0],e=t.between[1],t.x=e.x-(1+t.childIdx)*(e.x-n.x)/(e.maxChildIdx+1),t.y=e.y-(1+t.childIdx)*(e.y-n.y)/(e.maxChildIdx+1)),x(t)}),l.call(o),d.call(r)}var a,u,l,d,h,s=50,f=function(t){return"arrow"},p=function(t){return t.children},g=function(t){return t.name},x=function(t){},m=t.scale.log().domain([1,5]).range([60,30]),w=t.layout.force().gravity(0).size([window.document.documentElement.clientWidth,window.document.documentElement.clientHeight]).linkDistance(i).chargeDistance([10]).on("tick",c),y=function(n){u=[],a=[],e(n.datum()),w.nodes(a).links(u),d=n.selectAll(".link").data(u),d.enter().append("line"),d.attr({"class":function(t){return"link link-"+t.depth},"marker-end":function(t){return t.arrow?"url(#"+f(t)+")":null}}),d.exit().remove(),l=n.selectAll(".node").data(a),l.enter().append("g").attr({"class":function(t){return"node"+(t.root?" root":"")}}).append("text"),l.select("text").attr({"class":function(t){return"label-"+t.depth},"text-anchor":function(t){return t.depth?t.horizontal?"end":"middle":"start"},dy:function(t){return t.horizontal?".35em":1===t.region?"1em":"-.2em"}}).text(g),l.exit().remove(),l.call(w.drag).on("mousedown",function(){t.event.stopPropagation()}),h=n.select(".root").node()};return y.links=function(){return u},y.nodes=function(){return a},y.force=function(){return w},y.defaultArrow=n,y.margin=function(t){return arguments.length?(s=t,my):s},y.children=function(t){return arguments.length?(p=t,my):p},y.label=function(t){return arguments.length?(g=t,my):g},y.perNodeTick=function(t){return arguments.length?(x=t,my):x},y}}.call(this,d3);