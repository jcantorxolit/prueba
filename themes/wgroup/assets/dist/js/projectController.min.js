"use strict";app.controller("projectCtrl",["$scope","flowFactory","$aside","$stateParams","$log","DTOptionsBuilder","DTColumnBuilder","DTColumnDefBuilder","$compile","toaster","$state","$rootScope","$timeout","$http","SweetAlert","$filter","$uibModal","ChartService","ListService","ngNotify",function(e,t,a,n,o,r,i,l,c,s,u,d,p,f,m,h,g,w,v,T){function b(){var t=[{name:"month",value:null},{name:"customer_project_year",value:null},{name:"current_year",value:null},{name:"current_month",value:null},{name:"project_type",value:null},{name:"project_concepts",value:null},{name:"project_classifications",value:null},{name:"arl",value:null},{name:"agent",value:null},{name:"agent_skill",value:null},{name:"customer_project_task_type",value:null},{name:"project_invoice_status",value:null}];v.getDataList(t).then(function(t){if(e.months=t.data.data.month,e.years=t.data.data.yearList,e.taskTypes=t.data.data.projectTaskTypeList,e.arls=t.data.data.arl,e.skills=t.data.data.agent_skill,e.types=t.data.data.project_type,e.conceptList=t.data.data.project_concepts,e.classificationList=t.data.data.project_classifications,e.invoiceStatusList=t.data.data.project_invoice_status,e.agentsFilter=d.agents(),e.years.length>0){var a=h("filter")(e.years,{id:t.data.data.currentYear},!0);a.length>0?e.filter.selectedYear=a[0]:e.filter.selectedYear=e.years[0]}else e.filter.selectedYear={id:t.data.data.currentYear,item:t.data.data.currentYear,value:t.data.data.currentYear};var n=h("filter")(e.months,{value:t.data.data.currentMonth.toString()},!0);n.length>0&&(e.filter.selectedMonth=n[0]),e.currentMonth=t.data.data.currentMonth,e.currentYear=t.data.data.currentYear,C(),D(),e.canShowTable?A():O()},function(t){e.status="Unable to load customer data: "+t.message})}function C(){e.filter.administrator=null;var t=[{name:"customer_project_administrators",criteria:{type:d.currentUser().wg_type,year:e.filter.selectedYear?e.filter.selectedYear.value:null,month:e.filter.selectedMonth?e.filter.selectedMonth.value:null,customerId:e.filter.selectedCustomer?e.filter.selectedCustomer.id:null}}];v.getDataList(t).then(function(t){e.filter.administrator=null,e.administratorList=t.data.data.projectAdministratorList},function(t){e.status="Unable to load customer data: "+t.message})}function y(){var t=[{name:"chart_doughnut_options",criteria:null}];w.getDataChart(t).then(function(t){e.chart.doughnut.options=t.data.data.chartDoughnutOptions,e.chart.doughnut.options.legend.position="top",e.chart.doughnut.options.maintainAspectRatio=!1,e.chart.doughnut.options.responsive=!1},function(t){e.status="Unable to load customer data: "+t.message})}function j(t){var n=a.open({templateUrl:d.app.views.urlRoot+"modules/project/project_edit_modal.htm",placement:"right",size:"lg",backdrop:!0,controller:"ModalProjectInstanceSideCtrl",scope:e,resolve:{project:function(){return t},isView:function(){return e.isView}}});n.result.then(function(t,a){e.currentProjectAgentId=0,D(),A()},function(){})}function k(t){var n=a.open({templateUrl:d.app.views.urlRoot+"modules/project/project_task_edit_modal.htm",placement:"right",size:"lg",backdrop:!0,controller:"ModalInstanceSideTaskCtrl",scope:e,resolve:{project:function(){return t},isView:function(){return e.isView}}});n.result.then(function(t,a){e.currentProjectAgentId=0,D(),A()},function(){})}e.currentProjectAgentId=0,e.isAgent="agent"==d.currentUser().wg_type,e.isAdmin="system"==d.currentUser().wg_type,e.isCustomer="customerAdmin"==d.currentUser().wg_type||"customerUser"==d.currentUser().wg_type,e.chart={bar:{options:null},doughnut:{options:null},programs:{data:null},summary:{data:null,total:0}},e.filter={selectedCustomer:null,selectedAgent:null,selectedMonth:null,selectedYear:null,selectedARL:null,selectedType:null,selectedOS:null,administrator:null};var S={refresh:!0,index:0};b();var D=function(){var t={type:d.currentUser().wg_type,customerId:e.filter.selectedCustomer?e.filter.selectedCustomer.id:null,agentId:e.filter.selectedAgent?e.filter.selectedAgent.id:null,month:e.filter.selectedMonth?e.filter.selectedMonth.value:null,year:e.filter.selectedYear?e.filter.selectedYear.value:null,odes:e.filter.selectedOS?e.filter.selectedOS:null,projectType:e.filter.selectedType?e.filter.selectedType.value:null,arl:e.filter.selectedARL?e.filter.selectedARL.value:null,administrator:e.filter.administrator?e.filter.administrator.value:null,isBilled:null},a=[{name:"customer_project_summary",value:null,criteria:t},{name:"customer_project_agent_task_timeline",value:null,criteria:t}];v.getDataList(a).then(function(t){e.projectSummary=t.data.data.projectSummary,e.recentTasks=t.data.data.projectAgentTaskTimeLine,e.chart.summary.data=t.data.data.chartProjectSummary},function(t){e.status="Unable to load customer data: "+t.message})};y(),e.taskTypes=[],e.arls=[],e.agents=[],e.filterAgents=[],e.customerList=[],e.projectTasks=[],e.projects=[],e.recentTasks=[],e.canShowTable=!1;var O=function(){e.canShowTable=!0,p(function(){var t=function(){var e=[{command:[{text:" ",template:"<a class='btn btn-success btn btn-xs' ng-click='onEditProject(dataItem)' uib-tooltip='Editar' tooltip-placement='right'><i class='fa fa-edit'></i></a> "},{text:" ",template:"<a class='btn btn-warning btn btn-xs' ng-click='viewProjectTask(dataItem)' uib-tooltip='Ver Tareas' tooltip-placement='right'><i class='fa fa-list'></i></a> "},{text:" ",template:"<a class='btn btn-dark-azure btn btn-xs' ng-click='onAddTask(dataItem)' uib-tooltip='Nueva Tarea' tooltip-placement='right'><i class='fa fa-plus-circle'></i></a> "},{text:" ",template:"<a class='btn btn-light-red btn btn-xs' ng-click='onAddComment(dataItem)' uib-tooltip='Comentarios' tooltip-placement='right'><i class='fa fa-comments'></i></a> "},{text:" ",template:"<a class='btn btn-info btn btn-xs' ng-click='onAddAttachment(dataItem)' uib-tooltip='Anexos' tooltip-placement='right'><i class='fa fa-paperclip'></i></a> "},{text:" ",template:"<a class='btn btn-dark-green btn btn-xs' ng-click='onDownloadAttachment(dataItem)' uib-tooltip='Descargar Anexos' tooltip-placement='right'><i class='fa fa-download'></i></a> "},{text:" ",template:"<a class='btn btn-dark-red btn btn-xs' ng-click='onAddReasonCancel(dataItem)' uib-tooltip='Cancelar' tooltip-placement='right'><i class='fa fa-ban'></i></a> "},{text:" ",template:"<a class='btn btn-dark-orange btn btn-xs' ng-click='onAddReasonReSchedule(dataItem)' uib-tooltip='Reprogramar' tooltip-placement='right'><i class='fa fa-calendar-check-o'></i></a> "}],locked:!1,width:"180px"}];return e.push(a("customerName","Empresa","300px")),e.push(a("name","Nombre","300px")),e.push(a("description","Descripción","200px")),e.push(a("type","Tipo","200px")),e.push(a("serviceOrder","Odes/Consec.","200px")),e.push(a("agentName","Asesor","200px")),e.push(a("administrator","Administrador","200px")),e.push(a("assignedHours","H. Asignadas","200px","danger-header")),e.push(a("scheduledHours","H. Programadas","200px","info-header")),e.push(a("runningHours","H. Ejecutadas","200px","success-header")),e.push(a("statusText","Estado","200px",!1,function(e){return e.status})),e},a=function(e,t,a,n,o,r){return{field:e,title:t,width:a,minScreenWidth:100,headerAttributes:{"class":n,style:""==t?"display: none":""},filterable:void 0!==o&&o,template:"function"==typeof r?r:null}};e.mainGridOptions={dataSource:{type:"odata",transport:{read:{url:"api/customer-project/activities",dataType:"json",type:"POST",data:function(){var t={type:d.currentUser().wg_type,customerId:e.filter.selectedCustomer?e.filter.selectedCustomer.id:null,agentId:e.filter.selectedAgent?e.filter.selectedAgent.id:null,month:e.filter.selectedMonth?e.filter.selectedMonth.value:null,year:e.filter.selectedYear?e.filter.selectedYear.value:null,odes:e.filter.selectedOS?e.filter.selectedOS:null,projectType:e.filter.selectedType?e.filter.selectedType.value:null,arl:e.filter.selectedARL?e.filter.selectedARL.value:null,administrator:e.filter.administrator?e.filter.administrator.value:null,isBilled:null};return t}},parameterMap:function(e,t){return JSON.stringify(e)}},schema:{model:{id:"id",fields:{}},data:function(e){return e.data||e},total:function(e){return e.recordsTotal||e.data.length||0}},pageSize:10,serverPaging:!0,serverFiltering:!0,serverSorting:!0},noRecords:!0,scrollable:!0,sortable:{mode:"multiple"},pageable:{change:function(e){S.index=e.index}},filterable:!1,dataBinding:function(e){o.info("dataBinding")},dataBound:function(t){e.grid.tbody.find("tr").each(function(){var t=e.grid.dataItem(this),a=d.can("projects_show_comments_card"),n=d.can("projects_show_attachments_card"),o=d.can("projects_download_attachments");a||$(this).find(".btn-light-red").remove(),n||$(this).find(".btn-info").remove(),o&&0!=t.countAttachment||$(this).find(".btn-dark-green").remove(),"En progreso"!=t.statusText&&($(this).find(".btn-dark-red").remove(),$(this).find(".btn-dark-orange").remove()),e.isAgent||$(this).find(".btn-dark-azure").remove(),e.isAdmin||($(this).find(".btn-success").remove(),$(this).find(".btn-warning").remove(),$(this).find(".btn-dark-red").remove(),$(this).find(".btn-dark-orange").remove())})},columns:t()}})},A=function(){void 0!==e.grid&&e.grid.dataSource.read()};e.$on("kendoWidgetCreated",function(t,a){void 0!==e.grid&&null!==e.grid||(e.grid=a)}),e.onAddProject=function(){j({id:0})},e.onEditProject=function(e){j(e)},e.onAddTask=function(e){k(e)},e.onAddReasonCancel=function(e){_(e,"C")},e.onAddReasonReSchedule=function(e){_(e,"R")},e.onDownloadAttachment=function(e){T.set("El archivo se está generando.",{position:"bottom",sticky:!0,button:!1,html:!0});var t={customerId:e.customerId,customerProjectId:e.id},a={},n=JSON.stringify(t);a.data=Base64.encode(n),f({method:"POST",url:"api/customer-project-document/export",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(a)}).then(function(e){var t=(e.data.path+e.data.filename,'<div class="row"></div> <div class="col-sm-12 text-center">Por favor espere y verifique su correo y la bandeja de mensajes!</div> </div>');T.set(t,{position:"bottom",sticky:!0,type:"info",button:!0,html:!0})})["catch"](function(e){T.set(e.data.message,{position:"bottom",sticky:!0,type:"error",button:!0,html:!0})})["finally"](function(){})};var _=function(e,t){var a=g.open({templateUrl:d.app.views.urlRoot+"modules/project/project_historial_modal.htm",controller:"ModalInstanceHistorialCtrl",windowTopClass:"top-modal",resolve:{type:function(){return t}}});a.result.then(function(a){if(a){var n={id:0,customerProjectId:e.id,type:t,reason:a.reason,deliveryDate:a.deliveryDate},o={},r=JSON.stringify(n);return o.data=Base64.encode(r),f({method:"POST",url:"api/customer-project-historial/save",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(o)}).then(function(e){p(function(){s.pop("success","Operación Exitosa","La información ha sido guardada satisfactoriamente."),A()})})["catch"](function(e){s.pop("Error","Error inesperado",e)})["finally"](function(){})}},function(){})};e.viewProjectTask=function(t){var n=a.open({templateUrl:d.app.views.urlRoot+"modules/project/project_task_view_modal.htm",placement:"bottom",size:"lg",backdrop:!0,controller:"ModalProjectTaskViewInstanceSideCtrl",scope:e,resolve:{project:function(){return t},isView:function(){return e.isView}}});n.result.then(function(t,a){e.currentProjectAgentId=0,D(),A()},function(){})},e.changeCustomer=function(){p(function(){D(),A()})},e.clearCustomer=function(){p(function(){e.filter.selectedCustomer=null,D(),A()})},e.changeAgent=function(){p(function(){D(),A()})},e.clearAgent=function(){p(function(){e.filter.selectedAgent=null,D(),A()})},e.changeMonth=function(){p(function(){C(),D(),A()})},e.clearMonth=function(){p(function(){e.filter.selectedMonth=null,D(),A()})},e.changeYear=function(){p(function(){C(),D(),A()})},e.clearYear=function(){p(function(){e.filter.selectedYear=null,D(),A()})},e.changeARL=function(){p(function(){D()})},e.clearARL=function(){p(function(){e.filter.selectedARL=null,D(),A()})},e.changeType=function(){p(function(){D(),A()})},e.clearType=function(){p(function(){e.filter.selectedType=null,D(),A()})},e.searchOS=function(){p(function(){D(),A()})},e.clearOS=function(){p(function(){e.filter.selectedOS=null,D(),A()})},e.clearAdministrator=function(){p(function(){e.filter.administrator=null,D(),A()})},e.sendStatus=function(){var t=g.open({templateUrl:"projectStatus.html",controller:"ModalInstanceProjectTrackingCtrl",windowTopClass:"top-modal",resolve:{project:function(){return{id:0,status:"sendStatus",tracking:{action:"",description:""}}},action:function(){return"Enviar Estado Proyectos"},filters:function(){return e.filter}}});t.result.then(function(){},function(){})},e.refreshAll=function(){D(),A()},e.onBilling=function(){u.go("app.projects.billing")},e.onSearchCustomer=function(){var t=a.open({templateUrl:d.app.views.urlRoot+"modules/common/modals/data_table_list_modal.htm",placement:"right",size:"lg",backdrop:!0,controller:"ModalInstanceSideProjectSearchCustomerCtrl",scope:e,windowTopClass:"top-modal",resolve:{}});t.result.then(function(t){var a=h("filter")(e.customerList,{id:t.id});0==a.length&&e.customerList.push(t),e.filter.selectedCustomer=t,e.changeCustomer(t),C()},function(){})},e.onAddAttachment=function(t){var n=a.open({templateUrl:d.app.views.urlRoot+"modules/customer/common/modals/customer_document_modal.htm",placement:"right",size:"lg",backdrop:!0,controller:"ModalProjectAttachmentInstanceSideCtrl",scope:e,resolve:{item:function(){return t},customer:function(){return e.currentCustomer?e.currentCustomer:e.filter.selectedCustomer},isView:function(){return e.isView}}});n.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},e.onAddComment=function(t){var n=a.open({templateUrl:d.app.views.urlRoot+"modules/customer/common/modals/customer_questions_comment_modal.htm",placement:"right",size:"lg",backdrop:!0,controller:"ModalProjecCommentInstanceSideCtrl",scope:e,resolve:{item:function(){return t},isView:function(){return e.isView}}});n.result.then(function(){e.reloadData()},function(){o.info("Modal dismissed at: "+new Date)})}}]),app.controller("ModalProjectInstanceSideCtrl",["$rootScope","$scope","$uibModalInstance","project","$log","$timeout","SweetAlert","isView","$http","$filter","toaster","$aside",function(e,t,a,n,o,r,i,l,c,s,u,d){function p(e){var a=s("filter")(t.conceptList,{code:e.value}),n=s("filter")(t.conceptList,{value:"PCOSGA"});t.activeConceptList=a.concat(n),f()}function f(){t.project.associatedCosts.forEach(function(e){var a=s("filter")(t.classificationList,{code:e.concept.value});e.classificationActiveList=a})}t.project=n,t.isView=l,t.items=[],t.isAgent="agent"==e.currentUser().wg_type,t.activeConceptList=[],t.datePickerConfig={culture:"es-CO",format:"dd/MM/yyyy"};var m=function(){t.project={id:n.id,name:"",deliveryDate:new Date,estimatedHours:0,isRecurrent:!1,serviceOrder:"",isBilled:!1,invoiceNumber:"",item:null,type:null,customer:null,status:null,defaultSkill:null,associatedCosts:[],costTotal:0,invoiceStatus:null,createdBy:n.id?null:e.currentUser().name},t.project.agents=[],t.project.projectTask={id:0,projectAgentId:0,type:null,task:"",observation:"",startDateTime:new Date,endDateTime:new Date,status:"activo"}};m();var h=function(){if(t.project.id){var e={id:n.id};c({method:"GET",url:"api/project",params:e})["catch"](function(e,t){if(403==t){var a=null!==e.message&&void 0!==e.message?e.message:"app.clientes.list";i.swal("No Autorizado","No estas autorizado para ver esta información.","error"),r(function(){$state.go(a)},3e3)}else 404==t?(i.swal("Información no disponible","Aporte no encontrado","error"),r(function(){$state.go("app.clientes.list")})):i.swal("Error","Se ha presentado un error al intentar acceder a la información del aporte","error")}).then(function(e){r(function(){t.project=e.data.result,t.project.deliveryDate&&(t.project.deliveryDate=new Date(t.project.deliveryDate.date)),t.project.customer=t.project.customer[0],v(t.project.defaultSkill.value),t.calculateGeneralTotal(),p(t.project.type)})})["finally"](function(){r(function(){t.loading=!1},400)})}};h(),t.ok=function(){a.close(1)},t.onCancel=function(){a.dismiss("cancel")},t.form={submit:function(e){var a=null;if(e.$invalid){var n=null,a=null;for(n in e)"$"!=n[0]&&(null!==a||e[n].$valid||(a=e[n].$name),e[n].$pristine&&(e[n].$dirty=!0));return angular.element(".ng-invalid[name="+a+"]").focus(),void r(function(){u.pop("error","Error","Por favor verifique los datos requeridos del formulario y vuelva a intentarlo")},500)}return 0==t.project.agents.length?void u.pop("error","Error","Debe adicionar al menos un recurso"):void g()},reset:function(e){e.$setPristine(!0)}};var g=function(){var e={};if(null!=t.project.deliveryDate){t.project.event_date=t.project.deliveryDate.toISOString();var a=JSON.stringify(t.project);return e.data=Base64.encode(a),c({method:"POST",url:"api/project/save",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(e)}).then(function(e){r(function(){r(function(){u.pop("success","Operación Exitosa","La información ha sido guardada satisfactoriamente")},500),t.projectTask=e.data.result,t.refreshAll(),t.ok()})})["catch"](function(e){o.error(e),i.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})}i.swal("Error de guardado","Error guardando el cliente por favor verifique la fecha ingresada!","error")};t.addAgent=function(e){i.swal({title:"Está seguro?",text:"Confirmas adicionar este recurso al proyecto?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, adicionar!",cancelButtonText:"No, cancelar!",closeOnConfirm:!0,closeOnCancel:!0},function(a){a?r(function(){var a=s("filter")(t.project.agents,{agentId:e.id});0==a.length?t.project.agents.push({id:0,agentId:e.id,projectId:0,scheduledHours:e.scheduledHours,notAssignedHours:e.notAssignedHours,name:e.name}):a[0].scheduledHours=parseInt(a[0].scheduledHours)+parseInt(e.scheduledHours)}):swal("Cancelación","La operación ha sido cancelada","error")})},t.removeAgentProject=function(e){i.swal({title:"Está seguro?",text:"Eliminará el registro seleccionado",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, adicionar!",cancelButtonText:"No, cancelar!",closeOnConfirm:!0,closeOnCancel:!0},function(a){a?r(function(){var a=t.project.agents[e];if(a.id){var n={};n.id=a.id,c({method:"POST",url:"api/project/agent/delete",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(n)}).then(function(e){swal("Eliminado","Registro eliminado satisfactoriamente","info")})["catch"](function(e){o.error(e),i.swal("Error en la eliminación","Se ha presentado un error durante la eliminación del registro. Por favor inténtelo de nuevo, si el error persiste, comuníquese con el administrador del sistema","error")})["finally"](function(){t.project.agents.splice(e,1)})}else t.project.agents.splice(e,1)}):swal("Cancelación","La operación ha sido cancelada","error")})},t.changeProjectType=function(e,a){null!=e&&(t.project.item=null,w(e.value)),t.refreshConcepts(e)},t.changeSkill=function(e,a){t.project.agents=[],v(e.value)};var w=function(e){var a={classification:e};return c({method:"POST",url:"api/budget/classification",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(a)}).then(function(e){r(function(){t.items=e.data.data})})["catch"](function(e){o.error(e),i.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})},v=function(a){var n={};n.skill=a;var o=JSON.stringify(e.currentUser());return n.data=o,c({method:"POST",url:"api/project/agent",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(n)}).then(function(e){r(function(){t.agentList=e.data.data})})["catch"](function(e){i.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})};t.onSearchCustomer=function(){var a=d.open({templateUrl:e.app.views.urlRoot+"modules/common/modals/data_table_list_modal.htm",placement:"right",size:"lg",backdrop:!0,controller:"ModalInstanceSideProjectSearchCustomerCtrl",scope:t,windowTopClass:"top-modal",resolve:{}});a.result.then(function(e){var a=s("filter")(t.customerList,{id:e.id});0==a.length&&t.customerList.push(e),t.project.customer=e},function(){})},t.onAddCost=function(){t.project.type&&t.project.associatedCosts.push({id:0,concept:null,classification:null,amount:0,price:0,totalValue:0,status:"PROGRAMADA",classificationActiveList:[]})},t.onRemoveCost=function(e,a){return 0===a?(t.project.associatedCosts.splice(e,1),void t.calculateGeneralTotal()):void i.swal({title:"Está seguro?",text:"Eliminará el registro seleccionado",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, adicionar!",cancelButtonText:"No, cancelar!",closeOnConfirm:!0,closeOnCancel:!0},function(n){return n?void r(function(){var n={id:a};c({method:"POST",url:"api/project/cost/delete",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(n)}).then(function(a){t.project.associatedCosts.splice(e,1),t.calculateGeneralTotal(),swal("Eliminado","Registro eliminado satisfactoriamente","info")})["catch"](function(e){o.error(e),i.swal("Error en la eliminación","Se ha presentado un error durante la eliminación del registro. Por favor inténtelo de nuevo, si el error persiste, comuníquese con el administrador del sistema","error")})}):void swal("Cancelación","La operación ha sido cancelada","error")})},t.refreshConcepts=function(e){p(e),t.project.associatedCosts.forEach(function(e){e.concept=null,e.classification=null,e.classificationActiveList=[]})},t.onChangeConcept=function(e,a){t.project.associatedCosts[a].classification=null;var n=s("filter")(t.classificationList,{code:e.value});t.project.associatedCosts[a].classificationActiveList=n},t.onCalculateTotalValue=function(e){e.totalValue=e.amount*e.price,t.calculateGeneralTotal()},t.calculateGeneralTotal=function(){t.project.costTotal=0,t.project.associatedCosts.forEach(function(e){t.project.costTotal+=Number.parseInt(e.totalValue)})}}]),app.controller("ModalInstanceSideTaskCtrl",["$rootScope","$scope","$uibModalInstance","project","$log","$uibModal","$timeout","SweetAlert","isView","$http","DTOptionsBuilder","DTColumnBuilder","$compile","toaster",function(e,t,a,n,o,r,i,l,c,s,u,d,p,f){t.project=n,t.limitDeliveryDate=e.parameters("projects_time_to_allow_create_task"),t.allowToSave=!1;var m=function(){t.projectTask={id:0,projectAgentId:n.projectAgentId,customerName:n.customerName,name:n.name,description:n.description,assignedHours:n.assignedHours,type:null,task:"",observation:"",startDateTime:new Date,endDateTime:new Date,status:"activo",tracking:{action:"",description:""}},t.validateSave()};t.validateSave=function(){var e=new Date(t.project.deliveryDate),a=e.getMonth()+1,n=t.limitDeliveryDate[0]?t.limitDeliveryDate[0].item:1,o=new Date(e.getFullYear(),a,n);new Date<o&&(t.allowToSave=!0)},m(),t.isView=c,t.reschedule=!1,t.onClose=function(){a.close(1)},t.onCancel=function(){a.dismiss("cancel")},t.form={submit:function(e){var a=null;if(e.$invalid){var n=null,a=null;for(n in e)"$"!=n[0]&&(null!==a||e[n].$valid||(a=e[n].$name),e[n].$pristine&&(e[n].$dirty=!0));return angular.element(".ng-invalid[name="+a+"]").focus(),void i(function(){f.pop("error","Error","Por favor verifique los datos requeridos del formulario y vuelva a intentarlo")},500)}var o=t.projectTask.startDateTime,r=t.projectTask.endDateTime;return o instanceof Date&&!isNaN(o.valueOf())&&r instanceof Date&&!isNaN(r.valueOf())?void h():void i(function(){f.pop("error","Error","Las fechas son requeridas. Por favor diligencia los datos del formulario y vuelva a intentarlo")},500)},reset:function(e){e.$setPristine(!0)}},t.cancelTask=function(a){var n={id:a,status:"cancelador",tracking:{action:"",description:""}},i=r.open({templateUrl:e.app.views.urlRoot+"modules/project/project_task_tracking_modal.htm",controller:"ModalInstanceTrackingCtrl",windowTopClass:"top-modal",resolve:{task:function(){return n},action:function(){return"Cancelar"}}});i.result.then(function(e){t.reloadData()},function(){o.info("Modal dismissed at: "+new Date),t.reloadData()})},t.completeTask=function(e){var t={id:e,status:"inactivo",tracking:{action:"",description:""}};g(t)},t.reloadTask=function(e){t.reschedule=!0;var a={id:e,status:"inactivo",tracking:{action:"Reprogramar",description:""}};w(a.id)};var h=function(){var e={},n=t.projectTask.startDateTime,o=t.projectTask.endDateTime;t.projectTask.startDateTime=t.projectTask.startDateTime.toISOString(),t.projectTask.endDateTime=t.projectTask.endDateTime.toISOString();var r=JSON.stringify(t.projectTask);return e.data=Base64.encode(r),s({method:"POST",url:"api/project/task/save",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(e)}).then(function(e){i(function(){l.swal("Validación exitosa","Procediendo con el guardado...","success"),a.close(1)})})["catch"](function(e){t.projectTask.startDateTime=n,t.projectTask.endDateTime=o;var a=e&&e.data&&e.data.message?e.data.message:"Error guardando el registro. Por favor verifique los datos ingresados!";l.swal("Error de guardado",a,"error")})["finally"](function(){})},g=function(e){var a={},n=JSON.stringify(e);return a.data=Base64.encode(n),s({method:"POST",url:"api/project/task/update",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(a)}).then(function(e){i(function(){l.swal("Validación exitosa","Procediendo con el guardado...","success"),t.projectTask=e.data.result,t.reloadData(),t.onClose()})})["catch"](function(e){o.error(e),l.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})},w=function(e){var a={id:e};s({method:"GET",url:"api/project/task",params:a})["catch"](function(e,t){if(403==t){var a=null!==e.message&&void 0!==e.message?e.message:"app.clientes.list";l.swal("No Autorizado","No estas autorizado para ver esta información.","error"),i(function(){$state.go(a)},3e3)}else 404==t?(l.swal("Información no disponible","Seguimiento no encontrado","error"),i(function(){$state.go("app.clientes.list")})):l.swal("Error","Se ha presentado un error al intentar acceder a la información del seguimiento","error")}).then(function(e){i(function(){t.projectTask=e.data.result,t.projectTask.startDateTime=new Date(t.projectTask.startDateTime.date),t.projectTask.endDateTime=new Date(t.projectTask.endDateTime.date),t.reschedule&&(t.projectTask.tracking={action:"Reprogramar",description:""})})})["finally"](function(){i(function(){t.loading=!1,t.isView=!1},400)})},v={};v.operation="tracking",v.project_agent_id=n.projectAgentId,t.dtInstanceTask={},t.dtOptionsTask=u.newOptions().withBootstrap().withOption("responsive",!0).withOption("ajax",{data:v,url:"api/project/tasks",type:"POST",beforeSend:function(){},complete:function(){}}).withDataProp("data").withOption("order",[[0,"desc"]]).withOption("serverSide",!0).withOption("processing",!0).withOption("fnPreDrawCallback",function(){return!0}).withOption("fnDrawCallback",function(){}).withOption("language",{}).withPaginationType("full_numbers").withOption("createdRow",function(e,a,n){p(angular.element(e).contents())(t)}),t.dtColumnsTask=[d.newColumn(null).withTitle("Acciones").withOption("width",80).notSortable().renderWith(function(e,t,a,n){var o="",r='<a class="btn btn-primary btn-xs" href="#" uib-tooltip="Completar tarea" ng-click="completeTask('+e.id+')" >   <i class="fa fa-check-circle-o"></i></a> ',i='<a class="btn btn-info btn-xs" href="#" uib-tooltip="Reprogramar tarea" ng-click="reloadTask('+e.id+')" >   <i class="fa fa-clock-o"></i></a> ',l='<a class="btn btn-danger btn-xs" href="#" uib-tooltip="Cancelar tarea" ng-click="cancelTask('+e.id+')">   <i class="fa fa-trash-o"></i></a> ';return"activo"==e.status&&(o+=i,o+=r,o+=l),o}),d.newColumn("task").withTitle("Tarea").withOption("width",100),d.newColumn("type").withTitle("Tipo").withOption("width",100),d.newColumn("startDateTime").withTitle("Fecha Inicio").withOption("width",100),d.newColumn("endDateTime").withTitle("Fecha Fin").withOption("width",100),d.newColumn("duration").withTitle("Duración").withOption("width",70),d.newColumn("status").withTitle("Estado").withOption("width",80).renderWith(function(e,t,a,n){var o="",r="";switch(e){case"activo":o="label label-success",r="Programada";break;case"cancelador":o="label label-danger",r="Cancelada";break;case"inactivo":o="label label-warning",r="Completada"}var i='<span class="'+o+'">'+r+"</span>";return i})],t.reloadData=function(){t.dtInstanceTask.reloadData()}}]),app.controller("ModalInstanceTrackingCtrl",["$scope","$uibModalInstance","task","action","$log","$timeout","SweetAlert","$http",function(e,t,a,n,o,r,i,l){e.task=a,e.task.tracking={action:n,description:""},e.ok=function(){t.close(1)},e.cancel=function(){t.dismiss("cancel")},e.saveTracking=function(){c()};var c=function(){var a={},n=JSON.stringify(e.task);return a.data=Base64.encode(n),l({method:"POST",url:"api/project/task/update",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(a)}).then(function(e){r(function(){i.swal("Validación exitosa","Procediendo con el guardado...","success"),t.close(1)})})["catch"](function(e){o.error(e),i.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})}}]),app.controller("ModalInstanceProjectTrackingCtrl",["$scope","$uibModalInstance","project","action","filters","$log","$timeout","SweetAlert","$http",function(e,t,a,n,o,r,i,l,c){e.report=a,e.report.tracking={action:n,description:""},e.onClose=function(){t.close(1)},e.onCancel=function(){t.dismiss("cancel")},e.saveTracking=function(){s()};var s=function(){var a={};e.report.customerId=null!=o.selectedCustomer?o.selectedCustomer.value:0,e.report.agentId=null!=o.selectedAgent&&""!=o.selectedAgent?o.selectedAgent.id:0,e.report.month=null!=o.selectedMonth?o.selectedMonth.value:0,e.report.year=null!=o.selectedYear?o.selectedYear.value:0,e.report.arl=null!=o.selectedARL?o.selectedARL.value:0,e.report.type=null!=o.selectedType?o.selectedType.value:0,e.report.os=""!=o.selectedOS?o.selectedOS:"";var n=JSON.stringify(e.report);return a.data=Base64.encode(n),c({method:"POST",url:"api/project/send-status",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(a)}).then(function(e){i(function(){l.swal("Validación exitosa","Procediendo con el guardado...","success"),t.close(1)})})["catch"](function(e){r.error(e),l.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})}}]),app.controller("ModalProjectTaskViewInstanceSideCtrl",["$scope","$uibModalInstance","project","$log","$uibModal","$timeout","SweetAlert","isView","$http","DTOptionsBuilder","DTColumnBuilder","$compile",function(e,t,a,n,o,r,i,l,c,s,u,d){e.project=a,e.ok=function(){t.close(1)},e.cancel=function(){t.dismiss("cancel")};var p={};p.operation="tracking",p.project_id=e.project.id,e.dtInstanceTask={},e.dtOptionsTask=s.newOptions().withBootstrap().withOption("responsive",!0).withOption("ajax",{data:p,url:"api/project/tasks/all",type:"POST",beforeSend:function(){},complete:function(){}}).withDataProp("data").withOption("order",[[0,"desc"]]).withOption("serverSide",!0).withOption("processing",!0).withOption("fnPreDrawCallback",function(){return!0}).withOption("fnDrawCallback",function(){}).withOption("language",{}).withPaginationType("full_numbers").withOption("createdRow",function(t,a,n){d(angular.element(t).contents())(e)}),e.dtColumnsTask=[u.newColumn("task").withTitle("Tarea"),u.newColumn("shortObservation").withTitle("Descriptión"),u.newColumn("type").withTitle("Tipo").withOption("width",200),u.newColumn("startDateTime").withTitle("Fecha Inicio").withOption("width",150),u.newColumn("endDateTime").withTitle("Fecha Fin").withOption("width",150),u.newColumn("duration").withTitle("Duración").withOption("width",150),u.newColumn("agent").withTitle("Asesor").withOption("width",400),u.newColumn("status").withTitle("Estado").withOption("width",80).renderWith(function(e,t,a,n){
var o="",r="";switch(e){case"activo":o="label label-success",r="Programada";break;case"cancelador":o="label label-danger",r="Cancelada";break;case"inactivo":o="label label-warning",r="Completada"}var i='<span class="'+o+'">'+r+"</span>";return i})],e.reloadData=function(){e.dtInstanceTask.reloadData()}}]),app.controller("ModalInstanceSideProjectSearchCustomerCtrl",["$rootScope","$stateParams","$scope","$uibModalInstance","$log","$timeout","SweetAlert","$http","toaster","$filter","FileUploader","DTColumnBuilder","DTOptionsBuilder","$compile",function(e,t,a,n,o,r,i,l,c,s,u,d,p,f){a.title="CLIENTES DISPONIBLES";var m=e.isAgent(),h=m?"api/customer-agent":"api/customer";a.entity={id:0},a.onCloseModal=function(){var e={id:a.entity.id,item:a.entity.businessName,value:a.entity.id,arl:a.entity.arl?a.entity.arl.item:null};n.close(e)},a.onCancel=function(){n.dismiss("cancel")};var g=function(e){if(0!=e){var t={id:e};l({method:"GET",url:"api/customer",params:t})["catch"](function(e,t){if(403==t){var a=null!==e.message&&void 0!==e.message?e.message:"app.clientes.list";i.swal("No Autorizado","No estas autorizado para ver esta información.","error"),r(function(){$state.go(a)},3e3)}else 404==t?i.swal("Información no disponible","Diagnóstico no encontrado","error"):i.swal("Error","Se ha presentado un error al intentar acceder a la información del proceso","error")}).then(function(e){r(function(){a.entity=e.data.result})})["finally"](function(){r(function(){a.onCloseModal()},400)})}else a.loading=!1};a.dtOptionsCommonDataTableList=p.newOptions().withBootstrap().withOption("responsive",!0).withOption("ajax",{data:function(e){return e.operation="customer",JSON.stringify(e)},url:h,contentType:"application/json",type:"POST",beforeSend:function(){},complete:function(){}}).withDataProp("data").withOption("order",[[0,"desc"]]).withOption("serverSide",!0).withOption("processing",!0).withOption("fnPreDrawCallback",function(){return!0}).withOption("fnDrawCallback",function(){w()}).withOption("language",{}).withPaginationType("full_numbers").withOption("createdRow",function(e,t,n){f(angular.element(e).contents())(a)}),a.dtColumnsCommonDataTableList=[d.newColumn(null).withTitle("Acciones").withOption("width",80).notSortable().renderWith(function(e,t,a,n){var o="",r="",i='<a class="btn btn-success btn-xs editRow lnk" href="#" uib-tooltip="Adicionar causa"  data-id="'+e.id+'"'+r+' >   <i class="fa fa-plus-square"></i></a> ';return o+=i}),d.newColumn("documentType").withTitle("Tipo de Documento").withOption("width",200),d.newColumn("documentNumber").withTitle("Nro Documento").withOption("width",200),d.newColumn("businessName").withTitle("Razón Social").withOption("width",200),d.newColumn("type").withTitle("Tipo de Cliente").withOption("width",200),d.newColumn("classification").withTitle("Clasificación").withOption("width",200).renderWith(function(e,t,a,n){return null==e||void 0==e?"":e}),d.newColumn("status").withTitle("Estado").withOption("width",200).renderWith(function(e,t,a,n){var o="";switch(e){case"Activo":o="label label-success";break;case"Inactivo":o="label label-danger";break;case"Retirado":o="label label-warning"}var r='<span class="'+o+'">'+e+"</span>";return r})];var w=function(){angular.element("#dtCommonDataTableList a.editRow").on("click",function(){var e=angular.element(this).data("id");g(e)})};a.dtInstanceCommonDataTableListCallback=function(e){a.dtInstanceCommonDataTableList=e},a.reloadData=function(){a.dtInstanceCommonDataTableList.reloadData()}}]),app.controller("ModalInstanceHistorialCtrl",["$scope","$uibModalInstance","type","$log","$timeout","SweetAlert","$http",function(e,t,a,n,o,r,i){e.title="C"==a?"Cancelar":"Reprogramar",e.isDateVisible="R"==a,e.datePickerConfig={culture:"es-CO",format:"dd/MM/yyyy",min:new Date},e.entity={reason:null,deliveryDate:null},e.ok=function(){t.close(1)},e.cancel=function(){t.dismiss("cancel")},e.saveTracking=function(){return null==e.entity.reason||""==e.entity.reason.trim()?void r.swal("Error","El motivo es requerido","error"):"R"==a&&null==e.entity.deliveryDate?void r.swal("Error","La feha de entrega es requerida","error"):void t.close(e.entity)}}]);
"use strict";app.controller("projectBudgetCtrl",["$scope","$stateParams","$log","DTOptionsBuilder","DTColumnBuilder","DTColumnDefBuilder","$compile","toaster","$state","$rootScope","$timeout","$http","SweetAlert","$document","$filter","$aside",function(t,e,n,a,i,o,r,l,d,c,u,s,f,p,m,w){t.dtInstanceBudget={},t.dtOptionsBudget=a.newOptions().withBootstrap().withOption("responsive",!0).withOption("ajax",{data:function(t){return JSON.stringify(t)},url:"api/budget-v2",contentType:"application/json",type:"POST",beforeSend:function(){},complete:function(){}}).withDataProp("data").withOption("order",[[0,"desc"]]).withOption("serverSide",!0).withOption("processing",!0).withOption("fnPreDrawCallback",function(){return!0}).withOption("fnDrawCallback",function(){h()}).withOption("language",{}).withPaginationType("full_numbers").withOption("createdRow",function(e,n,a){r(angular.element(e).contents())(t)}),t.dtColumnsBudget=[i.newColumn(null).withTitle("Acciones").withOption("width",220).notSortable().renderWith(function(t,e,n,a){var i="",o="",r='<a class="btn btn-primary btn-xs editRow lnk" href="#" uib-tooltip="Editar"  data-id="'+t.id+'"'+o+' >   <i class="fa fa-edit"></i></a> ',l='<a class="btn btn-danger btn-xs delRow lnk" href="#"  uib-tooltip="Eliminar" data-id="'+t.id+'"'+o+' >   <i class="fa fa-trash-o"></i></a> ';return c.can("clientes_edit"),i+=r,c.can("clientes_edit"),i+=l}),i.newColumn("item").withTitle("Rubro").withOption("width",200),i.newColumn("classification").withTitle("Clasificación").withOption("width",200),i.newColumn("description").withTitle("Descripción"),i.newColumn("year").withTitle("Año").withOption("width",200),i.newColumn(null).withTitle("Valor").withOption("width",200).renderWith(function(t,e,n,a){return m("currency")(t.amount,"$ ",2)})];var h=function(){angular.element("#dtBudget a.editRow").on("click",function(){var t=angular.element(this).data("id");g({id:t})}),angular.element("#dtBudget a.delRow").on("click",function(){var e=angular.element(this).data("id");f.swal({title:"Está seguro?",text:"Eliminará el registro seleccionado.",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, eliminar!",cancelButtonText:"No, continuar!",closeOnConfirm:!0,closeOnCancel:!0},function(a){if(a){var i={};i.id=e,s({method:"POST",url:"api/budget/delete",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(i)}).then(function(t){swal("Eliminado","Registro eliminado satisfactoriamente","info")})["catch"](function(t){n.error(t),f.swal("Error en la eliminación","Se ha presentado un error durante la eliminación del registro. Por favor inténtelo de nuevo, si el error persiste, comuníquese con el administrador del sistema","error")})["finally"](function(){t.reloadData()})}else swal("Cancelación","La operación ha sido cancelada","error")})})};t.dtInstanceBudgetCallback=function(e){t.dtInstanceBudget=e},t.reloadData=function(){t.dtInstanceBudget.reloadData()},t.onCreateNew=function(){g({id:0})};var g=function(e){var n=w.open({templateUrl:c.app.views.urlRoot+"modules/project/project_budget_modal.htm",placement:"right",size:"lg",backdrop:"static",controller:"modalSideBudgetCtrl",scope:t,resolve:{budget:function(){return e}}});n.result.then(function(){t.reloadData()},function(){t.reloadData()})}}]),app.controller("modalSideBudgetCtrl",["$rootScope","$stateParams","$scope","$uibModalInstance","budget","$log","$timeout","SweetAlert","$http","toaster","$filter","$aside","$document","DTColumnBuilder","DTOptionsBuilder","$compile","ListService",function(t,e,n,a,i,o,r,l,d,c,u,s,f,p,m,w,h){function g(){var t=[{name:"project_budget_year",value:null},{name:"month",value:null}];h.getDataList(t).then(function(t){n.years=u("orderBy")(t.data.data.project_budget_year,"value",!0),n.months=t.data.data.month},function(t){n.status="Unable to load customer data: "+t.message})}var b=o;n.maxDate=new Date,n.datePickerConfig={culture:"es-CO",format:"dd/MM/yyyy HH:mm"},n.loading=!0,n.isView=!1,n.isCreate=!0,n.types=t.parameters("project_type"),n.onCloseModal=function(){a.close(1)},n.onCancel=function(){a.dismiss("cancel")};var v=function(){n.budget={id:i.id,item:"",description:"",classification:null}};v(),g(),n.onLoadRecord=function(){if(0!=n.budget.id){var t={id:n.budget.id};d({method:"GET",url:"api/budget",params:t})["catch"](function(t,e){}).then(function(t){n.budget=t.data.result})["finally"](function(){r(function(){f.scrollTop(40,2e3)})})}},n.onLoadRecord(),n.form={submit:function(t){var e=null;if(t.$invalid){var a=null,e=null;for(a in t)"$"!=a[0]&&(null!==e||t[a].$valid||(e=t[a].$name),t[a].$pristine&&(t[a].$dirty=!0));return b.info(n.budget),angular.element(".ng-invalid[name="+e+"]").focus(),void l.swal("El formulario contiene errores!","Por favor corrige los errores del formulario e Intentalo de nuevo.","error")}C()},reset:function(t){n.onClear()}},n.onClear=function(){n.isView=!1,v()};var C=function(){var t={},e=JSON.stringify(n.budget);return t.data=Base64.encode(e),d({method:"POST",url:"api/budget/save",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){l.swal("Validación exitosa","El registro se guardó satisfactoriamente","success"),n.budget=t.data.result})["catch"](function(t){o.error(t),l.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){n.onClearDetail()})},O=function(){n.detail={id:0,budgetId:n.budget.id,year:null,month:null,amount:0}};O(),n.onAddDetail=function(){var t="";if(null==n.detail.year&&(t+="Debe seleccionar el año del periodo \n"),null==n.detail.month&&(t+="Debe seleccionar el mes del periodo \n"),""!=t)return void l.swal({html:!1,title:"Error de validación",text:t,type:"error"});var e={},a=JSON.stringify(n.detail);return e.data=Base64.encode(a),d({method:"POST",url:"api/budget-detail/save",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(e)}).then(function(t){n.onClearDetail(),n.reloadData()})["catch"](function(t){o.error(t),l.swal("Error de guardado",t.data.message,"error")})["finally"](function(){n.onClearDetail()})},n.onClearDetail=function(){O()};var D=function(t){0!=t&&d({method:"GET",url:"api/budget-detail/get",params:{id:t}})["catch"](function(t,e){}).then(function(t){r(function(){n.detail=t.data.result})})["finally"](function(){r(function(){f.scrollTop(40,2e3)})})};n.dtInstanceBudgetDetail={},n.dtOptionsBudgetDetail=m.newOptions().withBootstrap().withOption("responsive",!0).withOption("ajax",{data:function(t){return t.budgetId=n.budget.id,JSON.stringify(t)},url:"api/budget-detail",contentType:"application/json",type:"POST",beforeSend:function(){},complete:function(){}}).withDataProp("data").withOption("order",[[0,"desc"]]).withOption("serverSide",!0).withOption("processing",!0).withOption("fnPreDrawCallback",function(){return!0}).withOption("fnDrawCallback",function(){y()}).withOption("language",{}).withPaginationType("full_numbers").withOption("createdRow",function(t,e,a){w(angular.element(t).contents())(n)}),n.dtColumnsBudgetDetail=[p.newColumn(null).withTitle("Acciones").withOption("width",100).notSortable().renderWith(function(e,n,a,i){var o="",r="",l='<a class="btn btn-primary btn-xs editRow lnk" href="#" uib-tooltip="Editar"  data-id="'+e.id+'"'+r+' >   <i class="fa fa-edit"></i></a> ',d='<a class="btn btn-danger btn-xs delRow lnk" href="#"  uib-tooltip="Eliminar" data-id="'+e.id+'"'+r+' >   <i class="fa fa-trash-o"></i></a> ';return t.can("clientes_edit"),o+=l,t.can("clientes_edit"),o+=d}),p.newColumn("period").withTitle("Periodo"),p.newColumn(null).withTitle("Valor").withOption("width",200).renderWith(function(t,e,n,a){return u("currency")(t.amount,"$ ",2)})];var y=function(){angular.element("#dtBudgetDetail a.editRow").on("click",function(){var t=angular.element(this).data("id");B(t)}),angular.element("#dtBudgetDetail a.delRow").on("click",function(){var t=angular.element(this).data("id");l.swal({title:"Está seguro?",text:"Eliminará el registro seleccionado.",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, eliminar!",cancelButtonText:"No, continuar!",closeOnConfirm:!0,closeOnCancel:!0},function(e){if(e){var a={};a.id=t,d({method:"POST",url:"api/budget-detail/delete",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(a)}).then(function(t){swal("Eliminado","Registro eliminado satisfactoriamente","info")})["catch"](function(t){o.error(t),l.swal("Error en la eliminación","Se ha presentado un error durante la eliminación del registro. Por favor inténtelo de nuevo, si el error persiste, comuníquese con el administrador del sistema","error")})["finally"](function(){n.reloadData()})}else swal("Cancelación","La operación ha sido cancelada","error")})})};n.dtInstanceBudgetDetailCallback=function(t){n.dtInstanceBudgetDetail=t},n.reloadData=function(){n.dtInstanceBudgetDetail.reloadData()};var B=function(t){D(t)}}]);
"use strict";app.controller("projectBillingCtrl",["$scope","flowFactory","$aside","$stateParams","$log","DTOptionsBuilder","DTColumnBuilder","DTColumnDefBuilder","$compile","toaster","$state","$rootScope","$timeout","$http","SweetAlert","$filter","$uibModal",function(e,t,r,a,n,o,i,c,s,d,l,u,p,f,m,g,v){function h(t,a){var n=r.open({templateUrl:"app_project.html",placement:"right",size:"lg",backdrop:!0,controller:"ModalProjectInstanceSideCtrl",scope:e,resolve:{project:function(){return a},isview:function(){return e.isview}}});n.result.then(function(t,r){e.currentProjectAgentId=0,S(),A()})}function y(t,a){var n=r.open({templateUrl:"app_admin_projectTask.html",placement:"right",size:"lg",backdrop:!0,controller:"ModalInstanceSideTaskCtrl",scope:e,resolve:{project:function(){return a},isview:function(){return e.isview}}});n.result.then(function(t,r){e.currentProjectAgentId=0,S(),A()})}e.currentProjectAgentId=0,e.isAgent="agent"==u.currentUser().wg_type,e.isAdmin="system"==u.currentUser().wg_type,e.isCustomer="customerAdmin"==u.currentUser().wg_type||"customerUser"==u.currentUser().wg_type,e.currentCustomerId=0,e.currentAgentId=0,e.currentMonth=0,e.currentYear=0,e.currentARL=0,e.currentOS="",e.filter={},e.filter.selectedCustomer=null,e.filter.selectedAgent=null,e.filter.selectedMonth=null,e.filter.selectedYear=null,e.filter.selectedARL=null,e.filter.selectedOS=null,e.project={id:0,name:"",deliveryDate:new Date,estimatedHours:0,isRecurrent:!1,serviceOrder:"",isBilled:!1,invoiceNumber:""},e.project.type=null,e.project.customer=null,e.project.status=null,e.project.defaultSkill=null,e.project.agents=[],e.project.projectTask={id:0,projectAgentId:0,type:null,task:"",observation:"",startDateTime:new Date,endDateTime:new Date,status:"activo"},e.types=u.parameters("project_type"),e.taskTypes=[],e.arls=u.parameters("arl"),e.skills=u.parameters("agent_skill"),e.agents=[],e.agentsFilter=u.agents(),e.customers=[],e.months=[{id:"1",item:"Enero",value:"1"},{id:"2",item:"Febrero",value:"2"},{id:"3",item:"Marzo",value:"3"},{id:"4",item:"Abril",value:"4"},{id:"5",item:"Mayo",value:"5"},{id:"6",item:"Junio",value:"6"},{id:"7",item:"Julio",value:"7"},{id:"8",item:"Agosto",value:"8"},{id:"9",item:"Septiembre",value:"9"},{id:"10",item:"Octubre",value:"10"},{id:"11",item:"Noviembre",value:"11"},{id:"12",item:"Diciembre",value:"12"}],e.years=[{id:"2015",item:"2015",value:"2015"},{id:"2016",item:"2016",value:"2016"},{id:"2017",item:"2017",value:"2017"},{id:"2018",item:"2018",value:"2018"}];var j="//demos.telerik.com/kendo-ui/service",w=new kendo.data.GanttDataSource({batch:!1,transport:{read:{url:j+"/GanttTasks",dataType:"jsonp"},update:{url:j+"/GanttTasks/Update",dataType:"jsonp"},destroy:{url:j+"/GanttTasks/Destroy",dataType:"jsonp"},create:{url:j+"/GanttTasks/Create",dataType:"jsonp"},parameterMap:function(e,t){if("read"!==t)return{models:kendo.stringify(e.models||[e])}}},schema:{model:{id:"id",fields:{id:{from:"ID",type:"number"},orderId:{from:"OrderID",type:"number",validation:{required:!0}},parentId:{from:"ParentID",type:"number",defaultValue:null,validation:{required:!0}},start:{from:"Start",type:"date"},end:{from:"End",type:"date"},title:{from:"Title",defaultValue:"",type:"string"},percentComplete:{from:"PercentComplete",type:"number"},summary:{from:"Summary",type:"boolean"},expanded:{from:"Expanded",type:"boolean",defaultValue:!0}}}}}),T=new kendo.data.GanttDependencyDataSource({transport:{read:{url:j+"/GanttDependencies",dataType:"jsonp"},update:{url:j+"/GanttDependencies/Update",dataType:"jsonp"},destroy:{url:j+"/GanttDependencies/Destroy",dataType:"jsonp"},create:{url:j+"/GanttDependencies/Create",dataType:"jsonp"},parameterMap:function(e,t){if("read"!==t&&e.models)return{models:kendo.stringify(e.models)}}},schema:{model:{id:"id",fields:{predecessorId:{from:"PredecessorID",type:"number"},successorId:{from:"SuccessorID",type:"number"},type:{from:"Type",type:"number"}}}}});e.ganttOptions={dataSource:w,dependencies:T,views:["day",{type:"week",selected:!0},"month"],columns:[{field:"id",title:"ID",width:60},{field:"title",title:"Title",editable:!0},{field:"start",title:"Start Time",format:"{0:MM/dd/yyyy}",width:100},{field:"end",title:"End Time",format:"{0:MM/dd/yyyy}",width:100},{field:"duration",title:"Duration",width:100}],height:700,showWorkHours:!1,showWorkDays:!1},e.projectTasks=[],e.events=[],e.summaryProject={assignedHours:0,scheduledHours:0,runningHours:0,total:0,data:[{value:0,color:"#46BFBD",highlight:"#5AD3D1",label:"Asignadas"},{value:0,color:"#FDB45C",highlight:"#FFC870",label:"Ejecutadas"}]},e.projects=[],e.recentTasks=[],e.options={responsive:!1,segmentShowStroke:!0,segmentStrokeColor:"#fff",segmentStrokeWidth:2,percentageInnerCutout:50,animationSteps:100,animationEasing:"easeOutBounce",animateRotate:!0,animateScale:!1,legendTemplate:'<ul class="tc-chart-js-legend"><% for (var i=0; i<segments.length; i++){%><li><span style="background-color:<%=segments[i].fillColor%>"></span><%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>'},e.addProject=function(){e.project={id:0,name:"",deliveryDate:new Date,estimatedHours:0,isRecurrent:!1,serviceOrder:"",isBilled:!1,invoiceNumber:""},e.project.type={id:"0",item:"-- Seleccionar --",value:"-S-"},e.project.customer={id:"0",item:"-- Seleccionar --",value:"-S-"},e.project.status={id:"0",item:"-- Seleccionar --",value:"-S-"},e.project.defaultSkill={id:"0",item:"-- Seleccionar --",value:"-S-"},e.project.agents=[],e.project.projectTask={id:0,projectAgentId:0,type:null,task:"",observation:"",startDateTime:new Date,endDateTime:new Date,status:"activo"},e.agents=[],e.projectEdited(e.project)},e.editProject=function(t){var r={id:t.id};f({method:"GET",url:"api/project",params:r})["catch"](function(e,t){if(403==t){var r=null!==e.message&&void 0!==e.message?e.message:"app.clientes.list";m.swal("No Autorizado","No estas autorizado para ver esta información.","error"),p(function(){l.go(r)},3e3)}else 404==t?(m.swal("Información no disponible","Aporte no encontrado","error"),p(function(){l.go("app.clientes.list")})):m.swal("Error","Se ha presentado un error al intentar acceder a la información del aporte","error")}).then(function(t){p(function(){e.project=t.data.result,e.project.deliveryDate=new Date(e.project.deliveryDate.date),e.project.customer=e.project.customer[0],e.loadAgent(e.project.defaultSkill.value),e.projectEdited(e.project)})})["finally"](function(){p(function(){e.loading=!1},400),p(function(){})})},e.addTask=function(t){e.currentProjectAgentId=t.projectAgentId,P(),e.project.projectTask={id:0,projectAgentId:t.projectAgentId,customerName:t.customerName,name:t.name,description:t.description,assignedHours:t.assignedHours,type:null,task:"",observation:"",startDateTime:new Date,endDateTime:new Date,status:"activo"},e.taskEdited(e.project)},e.taskEdited=function(e){y("Edited",e)},e.projectEdited=function(e){h("Edited",e)},e.viewProjectTask=function(t){var a=r.open({templateUrl:"projectTaskView.html",placement:"bottom",size:"lg",backdrop:!0,controller:"ModalProjectTaskViewInstanceSideCtrl",scope:e,resolve:{project:function(){return t},isview:function(){return e.isview}}});a.result.then(function(t,r){e.currentProjectAgentId=0,S(),A()})};var S=function(){var t={};e.customer={};var r=JSON.stringify(e.customer);return t.data=Base64.encode(r),t.customer_id=e.currentCustomerId,t.agent_id=e.currentAgentId,t.month=e.currentMonth,t.year=e.currentYear,t.arl=e.currentARL,t.os=e.currentOS,t.isBilled=0,f({method:"POST",url:"api/project/summaryBilling",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){p(function(){e.projects=t.data.data})})["catch"](function(e){n.error(e),m.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})},k=function(){var t={};e.customer={};var r=JSON.stringify(e.customer);return t.data=Base64.encode(r),f({method:"POST",url:"api/project/fillList",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){p(function(){if(e.years=t.data.data.years,e.years.length>0){var r=g("filter")(e.years,{id:t.data.data.currentYear});r.length>0?e.filter.selectedYear=r[0]:e.filter.selectedYear=e.years[e.years.length-1]}else e.filter.selectedYear={id:t.data.data.currentYear,item:t.data.data.currentYear,value:t.data.data.currentYear};var a=g("filter")(e.months,{id:t.data.data.currentMonth});a.length>0&&(e.filter.selectedMonth=a[0]),e.currentMonth=t.data.data.currentMonth,e.currentYear=t.data.data.currentYear,S()})})["catch"](function(e){n.error(e),m.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})};k(),e.changeCustomer=function(t,r){p(function(){e.currentCustomerId=t.id,S()})},e.clearCustomer=function(){p(function(){e.currentCustomerId=0,e.filter.selectedCustomer=null,S()})},e.changeAgent=function(t,r){p(function(){e.currentAgentId=t.id,S()})},e.clearAgent=function(){p(function(){e.currentAgentId=0,e.filter.selectedAgent=null,S()})},e.changeMonth=function(t,r){p(function(){e.currentMonth=t.id,S()})},e.clearMonth=function(){p(function(){e.currentMonth=0,e.filter.selectedMonth=null,S()})},e.changeYear=function(t,r){p(function(){e.currentYear=t.id,S()})},e.clearYear=function(){p(function(){e.currentYear=0,e.filter.selectedYear=null,S()})},e.changeARL=function(t,r){p(function(){e.currentARL=t.id,S()})},e.clearARL=function(){p(function(){e.currentARL=0,e.filter.selectedARL=null,S()})},e.searchOS=function(){p(function(){e.currentOS=e.filter.selectedOS,S()})},e.clearOS=function(){p(function(){e.currentOS="",e.filter.selectedOS="",S()})},e.sendStatus=function(){var t={id:0,status:"sendStatus",tracking:{action:"",description:""}},r=v.open({templateUrl:"projectStatus.html",controller:"ModalInstanceProjectTrackingCtrl",windowTopClass:"top-modal",resolve:{project:function(){return t},action:function(){return"Enviar Estado Proyectos"},filters:function(){return e.filter}}});r.result.then(function(e){},function(){})};var A=function(){var t={};e.customer={};var r=JSON.stringify(e.customer);return t.data=Base64.encode(r),f({method:"POST",url:"api/project/report",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){p(function(){t.data.data.length>0&&(e.recentTasks=t.data.data)})})["catch"](function(e){n.error(e),m.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})};e.loadAgent=function(t){var r={};r.skill=t;var a=JSON.stringify(e.customer);return r.data=a,f({method:"POST",url:"api/project/agent",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(r)}).then(function(t){p(function(){e.agents=t.data.data})})["catch"](function(e){n.error(e),m.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})};var D=function(){var t={},r=JSON.stringify(e.customer);return t.data=r,f({method:"POST",url:"api/customer/economic-group/list",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){p(function(){e.taskTypes=t.data.data.taskType})})["catch"](function(e){n.error(e),m.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){}),t.data=r,f({method:"POST",url:"api/project/customer",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){p(function(){e.customers=t.data.data})})["catch"](function(e){n.error(e),m.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})};S(),D(),e.refreshAll=function(){S()},e.changeSkill=function(t,r){e.project.agents=[],e.loadAgent(t.value)};var E=function(){var t={},r=JSON.stringify(e.customer);return t.data=r,f({method:"POST",url:"api/project/task",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){p(function(){e.events=t.data.data,e.events.forEach(function(e){e.startsAt=new Date(e.startsAt.date),e.endsAt=new Date(e.endsAt.date)})})})["catch"](function(e){n.error(e),m.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})};E();var P=function(){var t={project_agent_id:e.currentProjectAgentId},r=JSON.stringify(e.customer);return t.data=r,f({method:"POST",url:"api/project/tasks",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){p(function(){e.projectTasks=t.data.data})})["catch"](function(e){n.error(e),m.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})};e.onProjectAdmin=function(){l.go("app.projects.list")},e.onSaveBilling=function(){var t={},r={isValid:!0,projects:[]},a=!0;if(angular.forEach(e.projects,function(e){e.isBilled&&""==e.invoiceNumber?a=!1:e.isBilled&&""!=e.invoiceNumber&&r.projects.push(e)}),a){if(r.projects.length>0){var o=JSON.stringify(r);return t.data=Base64.encode(o),f({method:"POST",url:"api/project/updateBilling",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){p(function(){d.pop("success","Operación Exitosa","Facturas ingresadas"),e.refreshAll()})})["catch"](function(e){n.error(e),d.pop("error","Error","Ha ocurrido un error ingresando las facturas")})["finally"](function(){})}d.pop("error","Error","No hay proyectos marcados para facturar")}else d.pop("error","Error","El número de factura es requerido para los proyectos marcados como facturado")}}]);
"use strict";app.controller("projectPlanningCtrl",["$scope","flowFactory","$aside","$stateParams","$log","DTOptionsBuilder","DTColumnBuilder","DTColumnDefBuilder","$compile","toaster","$state","$rootScope","$timeout","$http","SweetAlert","$filter",function(e,t,r,a,n,o,i,c,s,l,d,u,p,f,m,g){function h(t,a){var n=r.open({templateUrl:"app_planning_project.html",placement:"right",size:"lg",backdrop:!0,controller:"PlanningProjectInstanceModalSideCtrl",scope:e,resolve:{project:function(){return a},isview:function(){return e.isview}}});n.result.then(function(t,r){e.currentProjectAgentId=0,e.refreshGantt()})}function v(t,a){var n=r.open({templateUrl:"app_planning_project_task.html",placement:"right",size:"lg",backdrop:!0,controller:"PlanningProjectTaskInstanceModalSideCtrl",scope:e,resolve:{project:function(){return a},isview:function(){return e.isview}}});n.result.then(function(t,r){e.currentProjectAgentId=0,e.refreshGantt()})}e.canShowGrantt=!1,e.currentProjectAgentId=0,e.isAgent="agent"==u.currentUser().wg_type,e.isAdmin="system"==u.currentUser().wg_type,e.isCustomer="customerAdmin"==u.currentUser().wg_type||"customerUser"==u.currentUser().wg_type,e.canCreateTask=!1,e.canCreateProject=!1,e.currentTask=null,e.currentCustomerId=0,e.currentAgentId=0,e.currentMonth=0,e.currentYear=0,e.filter={selectedType:{id:"1",item:"Grupo Económico",value:"GE"},selectedMonth:null,selectedYear:null,selectedAgent:null,selectedCustomer:null},e.project={id:0,name:"",deliveryDate:new Date,estimatedHours:0,isRecurrent:!1,serviceOrder:"",isBilled:!1,invoiceNumber:""},e.project.type=null,e.project.customer=null,e.project.status=null,e.project.defaultSkill=null,e.project.agents=[],e.project.projectTask={id:0,projectAgentId:0,type:null,task:"",observation:"",startDateTime:new Date,endDateTime:new Date,status:"activo"},e.projectTypes=u.parameters("project_type"),e.taskTypes=[],e.projectTaskResponsible=[],e.arls=u.parameters("arl"),e.skills=u.parameters("agent_skill"),e.agents=[],e.agentsFilter=u.agents(),e.filterCustomers=[],e.customers=[],e.economicGroups=[],e.customersList=[],e.types=[{id:"1",item:"Grupo Económico",value:"GE"},{id:"2",item:"Cliente",value:"CU"}],e.months=[{id:"1",item:"Enero",value:"1"},{id:"2",item:"Febrero",value:"2"},{id:"3",item:"Marzo",value:"3"},{id:"4",item:"Abril",value:"4"},{id:"5",item:"Mayo",value:"5"},{id:"6",item:"Junio",value:"6"},{id:"7",item:"Julio",value:"7"},{id:"8",item:"Agosto",value:"8"},{id:"9",item:"Septiembre",value:"9"},{id:"10",item:"Octubre",value:"10"},{id:"11",item:"Noviembre",value:"11"},{id:"12",item:"Diciembre",value:"12"}],e.years=[{id:"2015",item:"2015",value:"2015"},{id:"2016",item:"2016",value:"2016"},{id:"2017",item:"2017",value:"2017"},{id:"2018",item:"2018",value:"2018"}];var T=new kendo.data.GanttDataSource({batch:!1,type:"odata",transport:{read:{url:function(){var t={customerId:e.currentCustomerId,currentAgentId:e.currentAgentId,month:e.currentMonth,year:e.currentYear,type:e.filter.selectedType.value};return"api/project/gantt?data="+Base64.encode(JSON.stringify(t))},dataType:"json",type:"GET"},parameterMap:function(e,t){if("read"!==t)return{models:kendo.stringify(e.models||[e])}}},schema:{model:{id:"id",fields:{id:{from:"id",type:"string"},parentId:{from:"parentId",type:"string",defaultValue:null,validation:{required:!0}},start:{from:"startDate",type:"date"},end:{from:"endDateTime",type:"date"},title:{from:"businessName",defaultValue:"",type:"string"},originalId:{from:"originalId",defaultValue:"0",type:"number"},assignedHours:{from:"assignedHours",defaultValue:"0",type:"number"},scheduledHours:{from:"scheduledHours",defaultValue:"0",type:"number"},runningHours:{from:"runningHours",defaultValue:"0",type:"number"},percentComplete:{from:"percentage",defaultValue:"0",type:"number"},amount:{from:"amount",defaultValue:"0",type:"number"},classification:{from:"classification",defaultValue:"",type:"string"},summary:{from:"summary",type:"boolean"},expanded:{from:"expanded",type:"boolean",defaultValue:!0}}},data:function(e){return e.data||e},total:function(e){return e.recordsTotal||e.data.length||0}}});p(function(){e.canShowGrantt=!0,e.ganttOptions={dataSource:T,resources:{field:"resources",dataColorField:"Color",dataTextField:"Name",dataSource:{type:"odata",transport:{read:{url:function(){var t={customerId:e.currentCustomerId,currentAgentId:e.currentAgentId,month:e.currentMonth,year:e.currentYear,type:e.filter.selectedType.value};return"api/project/gantt-resource?data="+Base64.encode(JSON.stringify(t))},dataType:"json",type:"GET"},parameterMap:function(e,t){if("read"!==t)return{models:kendo.stringify(e.models||[e])}}},schema:{model:{id:"id",fields:{id:{from:"ID",type:"number"}}},data:function(e){return e.data||e},total:function(e){return e.recordsTotal||e.data.length||0}}}},assignments:{dataTaskIdField:"TaskID",dataResourceIdField:"ResourceID",dataValueField:"Units",dataSource:{type:"odata",transport:{read:{url:function(){var t={customerId:e.currentCustomerId,currentAgentId:e.currentAgentId,month:e.currentMonth,year:e.currentYear,type:e.filter.selectedType.value};return"api/project/gantt-resource-assignment?data="+Base64.encode(JSON.stringify(t))},dataType:"json",type:"GET"},parameterMap:function(e,t){if("read"!==t)return{models:kendo.stringify(e.models||[e])}}},schema:{model:{id:"ID",fields:{ID:{type:"number"},ResourceID:{type:"number"},Units:{type:"number"},TaskID:{type:"string"}}},data:function(e){return e.data||e},total:function(e){return e.recordsTotal||e.data.length||0}}}},views:["day",{type:"week",selected:!0},"month"],messages:{views:{day:"Día",week:"Semana",month:"Mes",Year:"Año"}},toolbar:[{name:"pdf",text:"Exportar a PDF"}],pdf:{fileName:"Proyecto Planeacion",proxyURL:"//demos.telerik.com/kendo-ui/service/export"},change:function(t){var r,a=this.select();a&&(r=this.dataItem(a),p(function(){e.canCreateTask=!1,e.canCreateProject=!1,null!=r&&"undefined"!=typeof r.classification&&(e.currentTask=r,"CLIENTE GRUPO"==r.classification||"CLIENTE"==r.classification?e.canCreateProject=e.isAdmin:"PROYECTO"==r.classification&&(e.canCreateTask=!0))},300))},columns:[{field:"title",title:"Titulo",editable:!0,width:350},{field:"classification",title:"Tipo",width:100},{field:"start",title:"F Inicial",format:"{0:dd/MM/yyyy}",width:80},{field:"end",title:"F Final",format:"{0:dd/MM/yyyy}",width:80},{field:"assignedHours",title:"H. Asignadas",width:80},{field:"scheduledHours",title:"H. Programadas",width:80},{field:"runningHours",title:"H. Ejecutadas",width:80},{field:"amount",title:"Valor Tarea",width:100,format:"{0:c}"},{field:"resources",title:"Asesores",width:200}],height:700,showWorkHours:!1,showWorkDays:!1,editable:!1}},200),e.projectTasks=[],e.addProject=function(){e.project={id:0,name:"",deliveryDate:new Date,estimatedHours:0,isRecurrent:!1,serviceOrder:"",isBilled:!1,invoiceNumber:""};var t=g("filter")(e.customersList,{id:e.currentTask.originalId.toString()},!0);e.project.customer=t.length>0?t[0]:null,e.project.type=null,e.project.status=null,e.project.defaultSkill=null,e.project.agents=[],e.project.projectTask={id:0,projectAgentId:0,type:null,task:"",observation:"",startDateTime:new Date,endDateTime:new Date,status:"activo"},e.agents=[],e.projectEdited(e.project)},e.editProject=function(t){var r={id:t.id};f({method:"GET",url:"api/project",params:r})["catch"](function(e,t){if(403==t){var r=null!==e.message&&void 0!==e.message?e.message:"app.clientes.list";m.swal("No Autorizado","No estas autorizado para ver esta información.","error"),p(function(){d.go(r)},3e3)}else 404==t?(m.swal("Información no disponible","Aporte no encontrado","error"),p(function(){d.go("app.clientes.list")})):m.swal("Error","Se ha presentado un error al intentar acceder a la información del aporte","error")}).then(function(t){p(function(){e.project=t.data.result,e.project.deliveryDate=new Date(e.project.deliveryDate.date),e.project.customer=e.project.customer[0],e.loadAgent(e.project.defaultSkill.value),e.projectEdited(e.project)})})["finally"](function(){p(function(){e.loading=!1},400),p(function(){})})},e.addTask=function(t){if(e.isAdmin||e.isAgent){var r={id:t.originalId};f({method:"GET",url:"api/project",params:r})["catch"](function(e,t){}).then(function(t){p(function(){e.project=t.data.result,e.project.deliveryDate=new Date(e.project.deliveryDate.date),e.project.customer=e.project.customer[0],e.projectTaskResponsible=e.project.agents,e.project.projectTask={id:0,projectAgentId:0,customerName:e.project.customerId.businessName,name:e.project.name,description:e.project.description,assignedHours:e.project.estimatedHours,type:null,task:"",observation:"",startDateTime:new Date,endDateTime:new Date,status:"activo"},e.taskEdited(e.project)})})["finally"](function(){})}},e.taskEdited=function(e){v("Edited",e)},e.projectEdited=function(e){h("Edited",e)},e.changeCustomer=function(t,r){p(function(){e.currentCustomerId=t.id,e.refreshGantt()})},e.clearCustomer=function(){p(function(){e.currentCustomerId=0,e.filter.selectedCustomer=null,e.refreshGantt()})},e.changeAgent=function(t,r){p(function(){e.currentAgentId=t.id,e.refreshGantt()})},e.clearAgent=function(){p(function(){e.currentAgentId=0,e.filter.selectedAgent=null,e.refreshGantt()})},e.changeMonth=function(t,r){p(function(){e.currentMonth=t.id,e.refreshGantt()})},e.clearMonth=function(){p(function(){e.currentMonth=0,e.filter.selectedMonth=null,e.refreshGantt()})},e.changeYear=function(t,r){p(function(){e.currentYear=t.id,e.refreshGantt()})},e.clearYear=function(){p(function(){e.currentYear=0,e.filter.selectedYear=null,e.refreshGantt()})},e.changeType=function(t,r){p(function(){e.filterCustomers="GE"==e.filter.selectedType.value?e.economicGroups:e.customers,e.clearCustomer(),e.refreshGantt()})},e.refreshGantt=function(){var e=$("div [kendo-gantt]").data("kendoGantt");e&&(e.dataSource.read(),e.resources.dataSource.read(),e.assignments.dataSource.read())},e.loadAgent=function(t){var r={};r.skill=t;var a=JSON.stringify(e.customer);return r.data=a,f({method:"POST",url:"api/project/agent",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(r)}).then(function(t){p(function(){e.agents=a.data})})["catch"](function(e){n.error(e),m.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})};var w=function(){var t={},r=JSON.stringify(e.customer);t.data=r,f({method:"POST",url:"api/customer/economic-group/list",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){p(function(){e.customers=t.data.data.customer,e.economicGroups=t.data.data.economicGroup,e.taskTypes=t.data.data.taskType,e.filterCustomers="GE"==e.filter.selectedType.value?e.economicGroups:e.customers})})["catch"](function(e){n.error(e),m.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){}),t.data=r,f({method:"POST",url:"api/project/customer",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){console.log(t),p(function(){e.customersList=t.data.data})})["catch"](function(e){n.error(e),m.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})};w(),e.changeSkill=function(t,r){e.project.agents=[],e.loadAgent(t.value)}}]),app.controller("PlanningProjectInstanceModalSideCtrl",["$scope","$uibModalInstance","project","$log","$timeout","SweetAlert","isview","$http","$filter","toaster",function(e,t,r,a,n,o,i,c,s,l){e.project=r,e.isview=i,e.datePickerConfig={culture:"es-CO",format:"dd/MM/yyyy hh:mm tt"},e.onClose=function(){t.close(1)},e.onCancel=function(){t.dismiss("cancel")},e.form={submit:function(t){var r=null;if(t.$invalid){var a=null,r=null;for(a in t)"$"!=a[0]&&(null!==r||t[a].$valid||(r=t[a].$name),t[a].$pristine&&(t[a].$dirty=!0));return angular.element(".ng-invalid[name="+r+"]").focus(),void n(function(){l.pop("error","Error","Por favor verifique los datos requeridos del formulario y vuelva a intentarlo")},500)}return 0==e.project.agents.length?void l.pop("error","Error","Debe adicionar al menos un recurso"):(n(function(){l.pop("success","Operación Exitosa","Procediendo con el guardado...")},500),void e.onSaveProject())},reset:function(e){e.$setPristine(!0)}},e.onSaveProject=function(){var t={};if(null!=e.project.deliveryDate){e.project.event_date=e.project.deliveryDate.toISOString();var r=JSON.stringify(e.project);return t.data=Base64.encode(r),c({method:"POST",url:"api/project/save",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){n(function(){o.swal("Validación exitosa","Procediendo con el guardado...","success"),e.onClose()})})["catch"](function(e){a.error(e),o.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})}o.swal("Error de guardado","Error guardando el cliente por favor verifique la fecha ingresada!","error")},e.removeAgent=function(t){o.swal({title:"Está seguro?",text:"Eliminará el registro seleccionado",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, eliminar!",cancelButtonText:"No, cancelar!",closeOnConfirm:!0,closeOnCancel:!0},function(r){r?n(function(){e.mainContact.info.splice(t,1)}):swal("Cancelación","La operación ha sido cancelada","error")})},e.addAgent=function(t){o.swal({title:"Está seguro?",text:"Confirmas adicionar este recurso al proyecto?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, adicionar!",cancelButtonText:"No, cancelar!",closeOnConfirm:!0,closeOnCancel:!0},function(r){r?n(function(){var r=s("filter")(e.project.agents,{agentId:e.agents[t].id});0==r.length?e.project.agents.push({id:0,agentId:e.agents[t].id,projectId:0,scheduledHours:e.agents[t].scheduledHours,notAssignedHours:e.agents[t].notAssignedHours,name:e.agents[t].name}):r[0].scheduledHours=parseInt(r[0].scheduledHours)+parseInt(e.agents[t].scheduledHours)}):swal("Cancelación","La operación ha sido cancelada","error")})},e.removeAgentProject=function(t){o.swal({title:"Está seguro?",text:"Eliminará el registro seleccionado",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, adicionar!",cancelButtonText:"No, cancelar!",closeOnConfirm:!0,closeOnCancel:!0},function(r){r?n(function(){var r=e.project.agents[t],n={};n.id=r.id,c({method:"POST",url:"api/project/agent/delete",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(n)}).then(function(e){swal("Eliminado","Registro eliminado satisfactoriamente","info")})["catch"](function(e){a.error(e),o.swal("Error en la eliminación","Se ha presentado un error durante la eliminación del registro. Por favor inténtelo de nuevo, si el error persiste, comuníquese con el administrador del sistema","error")})["finally"](function(){e.project.agents.splice(t,1)})}):swal("Cancelación","La operación ha sido cancelada","error")})}}]),app.controller("PlanningProjectTaskInstanceModalSideCtrl",["$scope","$uibModalInstance","project","$log","$uibModal","$timeout","SweetAlert","isview","$http","DTOptionsBuilder","DTColumnBuilder","$compile","toaster",function(e,t,r,a,n,o,i,c,s,l,d,u,p){e.project=r,e.projectTask=r.projectTask,e.projectTask.tracking={action:"",description:""},e.isview=c,e.reschedule=!1,e.onClose=function(){t.close(1)},e.onCancel=function(){t.dismiss("cancel")},e.form={submit:function(t){var r=null;if(t.$invalid){var a=null,r=null;for(a in t)"$"!=a[0]&&(null!==r||t[a].$valid||(r=t[a].$name),t[a].$pristine&&(t[a].$dirty=!0));return angular.element(".ng-invalid[name="+r+"]").focus(),void o(function(){p.pop("error","Error","Por favor verifique los datos requeridos del formulario y vuelva a intentarlo")},500)}return null==e.projectTask.startDateTime||null==e.projectTask.endDateTime?void o(function(){p.pop("error","Error","Las fechas son requeridas. Por favor diligencia los datos del formulario y vuelva a intentarlo")},500):(o(function(){p.pop("success","Operación Exitosa","Procediendo con el guardado...")},500),void f())},reset:function(e){e.$setPristine(!0)}},e.cancelTask=function(t){var r={id:t,status:"cancelador",tracking:{action:"",description:""}},o=n.open({templateUrl:"projectTracking.html",controller:"ModalInstanceTrackingCtrl",windowTopClass:"top-modal",resolve:{task:function(){return r},action:function(){return"Cancelar"}}});o.result.then(function(t){e.selected=t},function(){a.info("Modal dismissed at: "+new Date),e.reloadData()})},e.completeTask=function(e){var t={id:e,status:"inactivo",tracking:{action:"",description:""}};m(t)},e.reloadTask=function(t){e.reschedule=!0;var r={id:t,status:"inactivo",tracking:{action:"Reprogramar",description:""}};g(r.id)},e.$watch("projectTask.endDateTime - projectTask.startDateTime",function(){var t=new moment(e.projectTask.endDateTime),r=new moment(e.projectTask.startDateTime);e.projectTask.duration=moment.duration(t.diff(r)).hours()});var f=function(){var t={};e.projectTask.startDateTime=e.projectTask.startDateTime.toISOString(),e.projectTask.endDateTime=e.projectTask.endDateTime.toISOString();var r=JSON.stringify(e.projectTask);return t.data=Base64.encode(r),s({method:"POST",url:"api/project/task/save",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){o(function(){i.swal("Validación exitosa","Procediendo con el guardado...","success"),e.projectTask=t.data.result,e.onClose()})})["catch"](function(e){i.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})},m=function(t){var r={};e.projectTask.startDateTime=e.projectTask.startDateTime.toISOString(),e.projectTask.endDateTime=e.projectTask.endDateTime.toISOString();var n=JSON.stringify(t);return r.data=Base64.encode(n),s({method:"POST",url:"api/project/task/update",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(r)}).then(function(t){o(function(){i.swal("Validación exitosa","Procediendo con el guardado...","success"),e.projectTask=t.data.result,e.onClose()})})["catch"](function(e){a.error(e),i.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})},g=function(t){var r={id:t};s({method:"GET",url:"api/project/task",params:r})["catch"](function(e,t){if(403==t){var r=null!==e.message&&void 0!==e.message?e.message:"app.clientes.list";i.swal("No Autorizado","No estas autorizado para ver esta información.","error"),o(function(){$state.go(r)},3e3)}else 404==t?(i.swal("Información no disponible","Seguimiento no encontrado","error"),o(function(){$state.go("app.clientes.list")})):i.swal("Error","Se ha presentado un error al intentar acceder a la información del seguimiento","error")}).then(function(t){o(function(){e.projectTask=t.data.result,e.projectTask.startDateTime=new Date(e.projectTask.startDateTime.date),e.projectTask.endDateTime=new Date(e.projectTask.endDateTime.date),e.reschedule&&(e.projectTask.tracking={action:"Reprogramar",description:""})})})["finally"](function(){o(function(){e.loading=!1,e.isview=!0},400)})};e.request={},e.request.operation="tracking",e.request.project_agent_id=e.currentProjectAgentId,e.changeResponsible=function(t,r){o(function(){e.currentProjectAgentId=t.id,e.projectTask.projectAgentId=e.currentProjectAgentId,e.request.project_agent_id=e.currentProjectAgentId,e.reloadData()})},e.dtInstanceTask={},e.dtOptionsTask=l.newOptions().withBootstrap().withOption("responsive",!0).withOption("ajax",{data:e.request,url:"api/project/tasks",type:"POST",beforeSend:function(){},complete:function(){}}).withDataProp("data").withOption("order",[[0,"desc"]]).withOption("serverSide",!0).withOption("processing",!0).withOption("fnPreDrawCallback",function(){return!0}).withOption("fnDrawCallback",function(){}).withOption("language",{}).withPaginationType("full_numbers").withOption("createdRow",function(t,r,a){u(angular.element(t).contents())(e)}),e.dtColumnsTask=[d.newColumn(null).withTitle("Acciones").withOption("width",80).notSortable().renderWith(function(e,t,r,a){var n="",o='<a class="btn btn-primary btn-xs" href="#" uib-tooltip="Completar tarea" ng-click="completeTask('+e.id+')" >   <i class="fa fa-check-circle-o"></i></a> ',i='<a class="btn btn-info btn-xs" href="#" uib-tooltip="Reprogramar tarea" ng-click="reloadTask('+e.id+')" >   <i class="fa fa-clock-o"></i></a> ',c='<a class="btn btn-danger btn-xs" href="#" uib-tooltip="Cancelar tarea" ng-click="cancelTask('+e.id+')">   <i class="fa fa-trash-o"></i></a> ';return"activo"==e.status&&(n+=i,n+=o,n+=c),n}),d.newColumn("task").withTitle("Tarea").withOption("width",100),d.newColumn("type").withTitle("Tipo").withOption("width",100),d.newColumn("startDateTime").withTitle("Fecha Inicio").withOption("width",100),d.newColumn("endDateTime").withTitle("Fecha Fin").withOption("width",100),d.newColumn("status").withTitle("Estado").withOption("width",80).renderWith(function(e,t,r,a){var n="",o="";switch(e){case"activo":n="label label-success",o="Programada";break;case"cancelador":n="label label-danger",o="Cancelada";break;case"inactivo":n="label label-warning",o="Completada"}var i='<span class="'+n+'">'+o+"</span>";return i})],e.reloadData=function(){e.dtInstanceTask.reloadData()}}]);
"use strict";app.controller("projectAttachmentCtrl",["$scope","$stateParams","$log","DTOptionsBuilder","DTColumnBuilder","DTColumnDefBuilder","$compile","toaster","$state","$rootScope","$timeout","SweetAlert","$http","$filter","$document","$aside","FileUploader","$localStorage","$ngConfirm","ngNotify","ListService",function(e,t,n,o,a,r,i,l,s,c,u,d,m,f,p,h,w,C,g,v,b){function A(){var t=[{name:"customer_document_type",value:e.currentCustomerId},{name:"current_customer",value:e.currentCustomerId}];b.getDataList(t).then(function(t){e.documentType=t.data.data.customerDocumentType,e.currentCustomer=t.data.data.currentCustomer},function(t){e.status="Unable to load customer data: "+t.message})}var I=0,D=null;e.customerList=[],e.currentCustomerId=c.isCustomer()?c.currentUser().company:0,e.$storage=C.$default({hideCustomerInternalProjectAttachmentCanceled:!0}),e.isAgent="agent"==c.currentUser().wg_type,e.isAdmin="system"==c.currentUser().wg_type,e.isCustomer="customerAdmin"==c.currentUser().wg_type||"customerUser"==c.currentUser().wg_type,e.documentClassification=c.parameters("customer_document_classification"),e.documentStatus=c.parameters("customer_document_status"),e.isView="view"==e.$parent.modeDsp,e.filter={selectedCustomer:null},e.downloadUrl="",A();var y=function(){e.attachment={id:0,customerInternalProjectId:0,type:null,classification:null,status:e.documentStatus?e.documentStatus[0]:null,version:1,description:null},D&&D.$setPristine(!0)};y();var O=function(t){m({method:"GET",url:"api/customer-project-document/get",params:{id:t}})["catch"](function(e,t){if(403==t){var n=null!==e.message&&void 0!==e.message?e.message:"app.clientes.list";d.swal("No Autorizado","No estas autorizado para ver esta información.","error"),u(function(){s.go(n)},3e3)}else 404==t?(d.swal("Información no disponible","Anexo no encontrado","error"),u(function(){s.go("app.clientes.list")})):d.swal("Error","Se ha presentado un error al intentar acceder a la información del anexo","error")}).then(function(t){u(function(){e.attachment=t.data.result,e.attachment.version=parseInt(e.attachment.version)+1,A()})})["finally"](function(){u(function(){e.loading=!1},400)})};e.onSelectCustomer=function(){e.currentCustomerId=e.filter.selectedCustomer.value,y(),e.reloadData()},e.onSearchCustomer=function(){var t=h.open({templateUrl:c.app.views.urlRoot+"modules/common/modals/data_table_list_modal.htm",placement:"right",size:"lg",backdrop:!0,controller:"ModalInstanceSideProjectSearchCustomerCtrl",scope:e,windowTopClass:"top-modal",resolve:{}});t.result.then(function(t){var n=f("filter")(e.customerList,{id:t.id});0==n.length&&e.customerList.push(t),e.filter.selectedCustomer=t,e.onSelectCustomer()},function(){})},e.onClearCustomer=function(){e.filter.selectedCustomer=null,e.currentCustomerId=0,y(),e.reloadData()},e.form={submit:function(e){D=e;var t=null;if(e.$invalid){var n=null,t=null;for(n in e)"$"!=n[0]&&(null!==t||e[n].$valid||(t=e[n].$name),e[n].$pristine&&(e[n].$dirty=!0));return angular.element(".ng-invalid[name="+t+"]").focus(),void d.swal("El formulario contiene errores!","Por favor corrige los errores del formulario e Intentalo de nuevo.","error")}P()},reset:function(e){e.$setPristine(!0)}};var P=function(){var t={},o=JSON.stringify(e.attachment);return t.data=Base64.encode(o),m({method:"POST",url:"api/customer-project-document/save",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){u(function(){T.queue.length>0?(I=t.data.result.id,T.uploadAll()):(d.swal("Registro","La información ha sido guardada satisfactoriamente","success"),e.reloadData(),e.onClear())})})["catch"](function(e){n.error(e),d.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})},T=e.uploader=new w({url:"api/customer-project-document/upload",formData:[],removeAfterUpload:!0});T.filters.push({name:"customFilter",fn:function(e,t){return this.queue.length<10}}),T.onWhenAddingFileFailed=function(e,t,n){console.info("onWhenAddingFileFailed",e,t,n)},T.onAfterAddingFile=function(e){console.info("onAfterAddingFile",e)},T.onAfterAddingAll=function(e){console.info("onAfterAddingAll",e)},T.onBeforeUploadItem=function(e){console.info("onBeforeUploadItem",e);var t={id:I};e.formData.push(t)},T.onProgressItem=function(e,t){console.info("onProgressItem",e,t)},T.onProgressAll=function(e){console.info("onProgressAll",e)},T.onSuccessItem=function(e,t,n,o){console.info("onSuccessItem",e,t,n,o)},T.onErrorItem=function(e,t,n,o){console.info("onErrorItem",e,t,n,o)},T.onCancelItem=function(e,t,n,o){console.info("onCancelItem",e,t,n,o)},T.onCompleteItem=function(e,t,n,o){console.info("onCompleteItem",e,t,n,o)},T.onCompleteAll=function(){console.info("onCompleteAll"),e.reloadData(),e.onClear(),d.swal("Registro","La información ha sido guardada satisfactoriamente","success")},e.dtInstanceCustomerInternalProjectDocument={},e.dtOptionsCustomerInternalProjectDocument=o.newOptions().withBootstrap().withOption("responsive",!0).withOption("ajax",{data:function(t){return t.operation="document",t.customerId=e.filter.selectedCustomer?e.filter.selectedCustomer.id:e.currentCustomerId,e.$storage.hideCustomerInternalProjectAttachmentCanceled&&(t.statusCode="2"),JSON.stringify(t)},url:"api/customer-project-document",contentType:"application/json",type:"POST"}).withDataProp("data").withOption("order",[[0,"desc"]]).withOption("serverSide",!0).withOption("processing",!0).withOption("fnPreDrawCallback",function(){return!0}).withOption("fnDrawCallback",function(){S()}).withOption("language",{}).withPaginationType("full_numbers").withOption("createdRow",function(t,n,o){i(angular.element(t).contents())(e)}),e.dtColumnsCustomerInternalProjectDocument=[a.newColumn(null).withTitle("Acciones").withOption("width",150).notSortable().renderWith(function(e,t,n,o){var a=e.documentUrl?e.documentUrl:"",r="api/customer-project-document/download?id="+e.id,i="",l='<a target="_self" class="btn btn-primary btn-xs downloadDocumentRow lnk" href="'+r+'" uib-tooltip="Descargar anexo" data-id="'+e.id+'" >   <i class="fa fa-download"></i></a> ',s='<a class="btn btn-info btn-xs openDocumentRow lnk" target="_blank" href="'+a+'" uib-tooltip="Abrir anexo" data-id="'+e.id+'" >   <i class="fa fa-folder-open-o"></i></a> ',u='<a class="btn btn-danger btn-xs delDocumentRow lnk" href="#" uib-tooltip="Anular anexo" data-id="'+e.id+'" >   <i class="fa fa-ban"></i></a> ',d=!1;return null==e.protectionType?d=!0:"public"==e.protectionType?d=!0:"private"==e.protectionType&&1==e.hasPermission&&(d=!0),c.can("clientes_anexo_open")&&""!=a&&(i+=s),c.can("clientes_anexo_download")&&""!=a&&(i+=l),c.can("clientes_anexo_invalidate")&&(i+=u),d?i:""}),a.newColumn("documentType").withTitle("Tipo de documento").withOption("width",200).withOption("defaultContent",""),a.newColumn("classification").withTitle("Clasificación").withOption("width",200).withOption("defaultContent",""),a.newColumn("description").withTitle("Descripción").withOption("width",200).withOption("defaultContent",""),a.newColumn("version").withTitle("Versión").withOption("width",200).withOption("defaultContent",""),a.newColumn("createdAt").withTitle("Fecha Creación").withOption("width",200).withOption("defaultContent",""),a.newColumn("createdBy").withTitle("Usuario").withOption("width",200).withOption("defaultContent",""),a.newColumn("status").withTitle("Estado").withOption("width",200).renderWith(function(e,t,n,o){var a="";switch(e){case"Vigente":a="label label-success";break;case"Anulado":a="label label-danger"}var r='<span class="'+a+'">'+e+"</span>";return r})];var S=function(){angular.element("#dtCustomerInternalProjectDocument a.delDocumentRow").on("click",function(){var t=angular.element(this).data("id");g({boxWidth:"35%",useBootstrap:!1,animation:"bottom",closeAnimation:"scale",title:"Está seguro?",content:"<strong>Anulará</strong> el anexo seleccionado",scope:e,type:"red",typeAnimated:!0,buttons:{cancel:{text:"Anular y cambiar versión",btnClass:"btn-primary",action:function(n,o){e.attachment.id=t,e.isView=!1,O(t),l.pop("info","Anulación Anexo","El anexo se cargó satisfactoriamente, seleccione una nueva versión del documento")}},fullCancel:{text:"Anular definitivamente",btnClass:"btn-red",action:function(o,a){var r={};r.id=t,m({method:"POST",url:"api/customer-project-document/delete",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(r)}).then(function(t){swal("Eliminado","Anexo anulado satisfactoriamente","info"),e.reloadData()})["catch"](function(e){n.error(e),d.swal("Error en la eliminación","Se ha presentado un error durante la eliminación del registro. Por favor inténtelo de nuevo, si el error persiste, comuníquese con el administrador del sistema","error")})["finally"](function(){})}},closeAll:{text:"Cancelar",btnClass:"btn-default",action:function(e,t){}}}})})};e.dtInstanceCustomerInternalProjectDocumentCallback=function(t){e.dtInstanceCustomerInternalProjectDocument=t},e.reloadData=function(){e.dtInstanceCustomerInternalProjectDocument.reloadData()},e.onEdit=function(t){e.isView=!1,O(t)},e.onShowCancelledChange=function(){e.reloadData()},e.onClear=function(){y()}}]);
app.controller("ModalProjectAttachmentInstanceSideCtrl",["$stateParams","$rootScope","$scope","$uibModalInstance","$log","$timeout","SweetAlert","isView","item","customer","$filter","FileUploader","$http","DTColumnBuilder","DTOptionsBuilder","$compile","ListService","toaster",function(t,n,o,e,i,a,r,l,c,s,u,d,m,f,p,w,h,C){function g(){var t=[{name:"customer_document_type",value:c.customerId}];h.getDataList(t).then(function(t){o.documentType=t.data.data.customerDocumentType},function(t){o.status="Unable to load customer data: "+t.message})}var O=null,v=0;o.documentStatus=n.parameters("customer_document_status"),o.documentClassification=n.parameters("customer_document_classification"),o.isView=l;var b=function(){o.attachment={id:0,projectId:c.id,type:null,classification:null,status:o.documentStatus?o.documentStatus[0]:null,version:1,description:null},O&&O.$setPristine(!0)};b(),g(),o.onCloseModal=function(){e.close(1)},o.onCancel=function(){e.dismiss("cancel")},o.onClear=function(){b()};var A=o.uploader=new d({url:"api/customer-project-document/upload",formData:[],removeAfterUpload:!0});A.filters.push({name:"customFilter",fn:function(t,n){return this.queue.length<10}}),A.onWhenAddingFileFailed=function(t,n,o){console.info("onWhenAddingFileFailed",t,n,o)},A.onAfterAddingFile=function(t){console.info("onAfterAddingFile",t)},A.onAfterAddingAll=function(t){console.info("onAfterAddingAll",t)},A.onBeforeUploadItem=function(t){console.info("onBeforeUploadItem",t);var n={id:v};t.formData.push(n)},A.onProgressItem=function(t,n){console.info("onProgressItem",t,n)},A.onProgressAll=function(t){console.info("onProgressAll",t)},A.onSuccessItem=function(t,n,o,e){console.info("onSuccessItem",t,n,o,e)},A.onErrorItem=function(t,n,o,e){console.info("onErrorItem",t,n,o,e)},A.onCancelItem=function(t,n,o,e){console.info("onCancelItem",t,n,o,e)},A.onCompleteItem=function(t,n,o,e){console.info("onCompleteItem",t,n,o,e)},A.onCompleteAll=function(){console.info("onCompleteAll"),C.pop("success","Operación Exitosa","La información ha sido guardada satisfactoriamente"),o.reloadData(),o.onClear()},o.form={submit:function(t){if(O=t,t.$valid)return void D();var n=null,o=null;for(n in t)"$"!=n[0]&&(null!==o||t[n].$valid||(o=t[n].$name),t[n].$pristine&&(t[n].$dirty=!0));angular.element(".ng-invalid[name="+o+"]").focus(),r.swal("El formulario contiene errores!","Por favor corrige los errores del formulario e Intentalo de nuevo.","error")},reset:function(t){t.$setPristine(!0)}};var D=function(){var t={},n=JSON.stringify(o.attachment);return t.data=Base64.encode(n),m({method:"POST",url:"api/customer-project-document/save",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){a(function(){A.queue.length>0?(v=t.data.result.id,A.uploadAll()):(C.pop("success","Operación Exitosa","La información ha sido guardada satisfactoriamente"),o.reloadData(),o.onClear())})})["catch"](function(t){r.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})};o.dtInstanceCustomerDocumentModal={},o.dtOptionsCustomerDocumentModal=p.newOptions().withBootstrap().withOption("responsive",!0).withOption("ajax",{data:function(t){return t.projectId=c.id,t.statusCode="2",JSON.stringify(t)},url:"api/customer-project-document",contentType:"application/json",type:"POST",beforeSend:function(){},complete:function(){}}).withDataProp("data").withOption("order",[[0,"desc"]]).withOption("serverSide",!0).withOption("processing",!0).withOption("fnPreDrawCallback",function(){return!0}).withOption("fnDrawCallback",function(){I()}).withOption("language",{}).withPaginationType("full_numbers").withOption("createdRow",function(t,n,e){w(angular.element(t).contents())(o)}),o.dtColumnsCustomerDocumentModal=[f.newColumn(null).withTitle("Acciones").withOption("width",150).notSortable().renderWith(function(t,o,e,i){var a=t.documentUrl?t.documentUrl:"",r="api/customer-project-document/download?id="+t.id,l="",c='<a target="_self" class="btn btn-primary btn-xs downloadDocumentRow lnk" href="'+r+'" uib-tooltip="Descargar anexo" data-id="'+t.id+'" >   <i class="fa fa-download"></i></a> ',s='<a class="btn btn-info btn-xs openDocumentRow lnk" target="_blank" href="'+a+'" uib-tooltip="Abrir anexo" data-id="'+t.id+'" >   <i class="fa fa-folder-open-o"></i></a> ',u=!1;return null==t.protectionType?u=!0:"public"==t.protectionType?u=!0:"private"==t.protectionType&&1==t.hasPermission&&(u=!0),n.can("clientes_anexo_open")&&""!=a&&(l+=s),n.can("clientes_anexo_download")&&""!=a&&(l+=c),u?l:""}),f.newColumn("documentType").withTitle("Tipo de documento").withOption("width",200).withOption("defaultContent",""),f.newColumn("classification").withTitle("Clasificación").withOption("width",200).withOption("defaultContent",""),f.newColumn("description").withTitle("Descripción").withOption("width",200).withOption("defaultContent",""),f.newColumn("version").withTitle("Versión").withOption("width",200).withOption("defaultContent",""),f.newColumn("createdAt").withTitle("Fecha Creación").withOption("width",200).withOption("defaultContent",""),f.newColumn("status").withTitle("Estado").withOption("width",200).renderWith(function(t,n,o,e){var i="";switch(t){case"Vigente":i="label label-success";break;case"Anulado":i="label label-danger"}var a='<span class="'+i+'">'+t+"</span>";return a})];var I=function(){$("#dtCustomerDocumentModal a.editRow").on("click",function(){$(this).data("id"),$(this).data("url")})};o.dtInstanceCustomerDocumentModalCallback=function(t){o.dtInstanceCustomerDocumentModal=t},o.reloadData=function(){o.dtInstanceCustomerDocumentModal.reloadData()}}]);
app.controller("ModalProjecCommentInstanceSideCtrl",["$stateParams","$rootScope","$scope","$uibModalInstance","item","isView","$timeout","$http","toaster","DTColumnBuilder","DTOptionsBuilder","$compile",function(t,n,e,o,i,a,r,c,l,u,s,d){e.isView=a;var m=function(){e.entity={id:0,customerProjectId:i.id,comment:null,type:"M"}};m(),e.onCloseModal=function(){o.close(1)},e.onCancel=function(){o.dismiss("cancel")},e.onClear=function(){m()},e.form={submit:function(t){if(t.$valid)return void e.onSave();var n=null,o=null;for(n in t)"$"!=n[0]&&(null!==o||t[n].$valid||(o=t[n].$name),t[n].$pristine&&(t[n].$dirty=!0));angular.element(".ng-invalid[name="+o+"]").focus(),r(function(){l.pop("error","Error","Por favor verifique los datos requeridos del formulario y vuelva a intentarlo")},500)},reset:function(t){t.$setPristine(!0)}},e.onSave=function(){var t={},n=JSON.stringify(e.entity);return t.data=Base64.encode(n),c({method:"POST",url:"api/customer-project-comment/save",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)}).then(function(t){r(function(){l.pop("success","Operación Exitosa","La información ha sido guardada satisfactoriamente."),e.onClear(),e.reloadData()})})["catch"](function(t){l.pop("Error","Error inesperado",t)})["finally"](function(){})},e.dtOptionsQuestionComment=s.newOptions().withBootstrap().withOption("responsive",!0).withOption("ajax",{data:function(t){return t.customerProjectId=i.id,JSON.stringify(t)},url:"api/customer-project-comment",contentType:"application/json",type:"POST"}).withDataProp("data").withOption("order",[[0,"desc"]]).withOption("serverSide",!0).withOption("processing",!0).withOption("fnPreDrawCallback",function(){return!0}).withOption("fnDrawCallback",function(){}).withOption("language",{}).withPaginationType("full_numbers").withOption("createdRow",function(t,n,o){d(angular.element(t).contents())(e)}),e.dtColumnsQuestionComment=[u.newColumn("comment").withTitle("Comentario"),u.newColumn("createdBy").withTitle("Usuario").withOption("width",200).withOption("defaultContent",200),u.newColumn("createdAt").withTitle("Fecha").withOption("width",200)],e.dtInstanceQuestionCommentCallback=function(t){e.dtInstanceQuestionComment=t},e.reloadData=function(){e.dtInstanceQuestionComment.reloadData()}}]);
app.controller("ModalInstanceSideProjectSearchCustomerCtrl",["$rootScope","$stateParams","$scope","$uibModalInstance","$log","$timeout","SweetAlert","$http","toaster","$filter","FileUploader","DTColumnBuilder","DTOptionsBuilder","$compile",function(t,n,e,i,a,o,l,r,s,c,u,d,p,m){e.title="CLIENTES DISPONIBLES";var w=t.isAgent(),h=w?"api/customer-agent":"api/customer";e.entity={id:0},e.onCloseModal=function(){var t={id:e.entity.id,item:e.entity.businessName,value:e.entity.id,arl:e.entity.arl?e.entity.arl.item:null};i.close(t)},e.onCancel=function(){i.dismiss("cancel")};var f=function(t){if(0!=t){var n={id:t};r({method:"GET",url:"api/customer",params:n})["catch"](function(t,n){if(403==n){var e=null!==t.message&&void 0!==t.message?t.message:"app.clientes.list";l.swal("No Autorizado","No estas autorizado para ver esta información.","error"),o(function(){$state.go(e)},3e3)}else 404==n?l.swal("Información no disponible","Diagnóstico no encontrado","error"):l.swal("Error","Se ha presentado un error al intentar acceder a la información del proceso","error")}).then(function(t){o(function(){e.entity=t.data.result})})["finally"](function(){o(function(){e.onCloseModal()},400)})}else e.loading=!1};e.dtOptionsCommonDataTableList=p.newOptions().withBootstrap().withOption("responsive",!0).withOption("ajax",{data:function(t){return t.operation="customer",JSON.stringify(t)},url:h,contentType:"application/json",type:"POST",beforeSend:function(){},complete:function(){}}).withDataProp("data").withOption("order",[[0,"desc"]]).withOption("serverSide",!0).withOption("processing",!0).withOption("fnPreDrawCallback",function(){return!0}).withOption("fnDrawCallback",function(){b()}).withOption("language",{}).withPaginationType("full_numbers").withOption("createdRow",function(t,n,i){m(angular.element(t).contents())(e)}),e.dtColumnsCommonDataTableList=[d.newColumn(null).withTitle("Acciones").withOption("width",80).notSortable().renderWith(function(t,n,e,i){var a="",o="",l='<a class="btn btn-success btn-xs editRow lnk" href="#" uib-tooltip="Adicionar causa"  data-id="'+t.id+'"'+o+' >   <i class="fa fa-plus-square"></i></a> ';return a+=l}),d.newColumn("documentType").withTitle("Tipo de Documento").withOption("width",200),d.newColumn("documentNumber").withTitle("Nro Documento").withOption("width",200),d.newColumn("businessName").withTitle("Razón Social").withOption("width",200),d.newColumn("type").withTitle("Tipo de Cliente").withOption("width",200),d.newColumn("classification").withTitle("Clasificación").withOption("width",200).renderWith(function(t,n,e,i){return null==t||void 0==t?"":t}),d.newColumn("status").withTitle("Estado").withOption("width",200).renderWith(function(t,n,e,i){var a="";switch(t){case"Activo":a="label label-success";break;case"Inactivo":a="label label-danger";break;case"Retirado":a="label label-warning"}var o='<span class="'+a+'">'+t+"</span>";return o})];var b=function(){angular.element("#dtCommonDataTableList a.editRow").on("click",function(){var t=angular.element(this).data("id");f(t)})};e.dtInstanceCommonDataTableListCallback=function(t){e.dtInstanceCommonDataTableList=t},e.reloadData=function(){e.dtInstanceCommonDataTableList.reloadData()}}]);