"use strict";app.controller("quoteCtrl",["$scope","$stateParams","$log","DTOptionsBuilder","DTColumnBuilder","DTColumnDefBuilder","$compile","toaster","$state","$rootScope","SweetAlert","$http",function(t,e,i,n,o,a,r,l,s,c,d,u){var p=i,w={};p.info("entrando en... agentCtrl"),t.isAgent="agent"==c.currentUser().wg_type,t.isAdmin="system"==c.currentUser().wg_type,t.isCustomer="customerAdmin"==c.currentUser().wg_type||"customerUser"==c.currentUser().wg_type,t.isAgent?s.go("app.clientes.list"):t.isCustomer&&(p.info("Step 20"),s.go("app.clientes.view",{customerId:c.currentUser().company})),w.operation="quotes",t.dtOptions=n.newOptions().withBootstrap().withOption("responsive",!0).withOption("ajax",{data:w,url:"api/quote",type:"POST",beforeSend:function(){},complete:function(){}}).withDataProp("data").withOption("order",[[0,"desc"]]).withOption("serverSide",!0).withOption("processing",!0).withOption("fnPreDrawCallback",function(){return!0}).withOption("fnDrawCallback",function(){f()}).withOption("language",{}).withPaginationType("full_numbers").withOption("createdRow",function(e,i,n){r(angular.element(e).contents())(t)}),t.dtColumns=[o.newColumn(null).withTitle("Acciones").withOption("width",150).notSortable().renderWith(function(t,e,i,n){var o="",a='<a class="btn btn-primary btn-xs editRow lnk" href="#" uib-tooltip="Editar"  data-id="'+t.id+'" >   <i class="fa fa-edit"></i></a> ',r='<a class="btn btn-info btn-xs viewRow lnk" href="#" uib-tooltip="Ver" data-id="'+t.id+'" >   <i class="fa fa-eye"></i></a> ',l='<a class="btn btn-danger btn-xs delRow lnk" href="#" uib-tooltip="Eliminar" data-id="'+t.id+'" >   <i class="fa fa-trash-o"></i></a> ';return c.can("cotizaciones_view")&&(o+=r),c.can("cotizaciones_edit")&&(o+=a),c.can("cotizaciones_delete")&&(o+=l),o}),o.newColumn("customer.businessName").withTitle("Cliente").withOption("width",200),o.newColumn("deadlineFormat").withTitle("Fecha").withOption("width",200),o.newColumn("total").withTitle("Total").withOption("width",200),o.newColumn("totalModified").withTitle("Total Modificado").withOption("width",200),o.newColumn(null).withTitle("Estado").withOption("width",200).renderWith(function(t,e,i,n){var o="",a="";"Iniciada"==t.status.item?(o="label label-success",a="Iniciada"):(o="label label-danger",a="Completada");var r='<span class="'+o+'">'+a+"</span>";return r})];var f=function(){$("#dtQuote a.editRow").on("click",function(){var t=$(this).data("id");s.go("app.cotizaciones.edit",{quoteId:t})}),$("#dtQuote a.viewRow").on("click",function(){var t=$(this).data("id");s.go("app.cotizaciones.view",{quoteId:t})}),$("#dtQuote a.delRow").on("click",function(){var e=$(this).data("id");p.info("intenta eliminar el registro: "+e),d.swal({title:"Está seguro?",text:"Eliminará el registro seleccionado.",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, eliminar!",cancelButtonText:"No, continuar!",closeOnConfirm:!0,closeOnCancel:!0},function(n){if(n){var o={};o.id=e,u({method:"POST",url:"api/customer/delete",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(o)}).then(function(t){swal("Eliminado","Registro eliminado satisfactoriamente","info")})["catch"](function(t){i.error(t),d.swal("Error en la eliminación","Se ha presentado un error durante la eliminación del registro. Por favor inténtelo de nuevo, si el error persiste, comuníquese con el administrador del sistema","error")})["finally"](function(){t.reloadData()})}else swal("Cancelación","La operación ha sido cancelada","error")})})};t.onCreate=function(){s.go("app.cotizaciones.create")},t.reloadData=function(){p.info("reloading..."),t.dtOptions.reloadData()}}]);
"use strict";app.controller("quoteEditCtrl",["$scope","$stateParams","$log","DTOptionsBuilder","DTColumnBuilder","DTColumnDefBuilder","$compile","toaster","$state","SweetAlert","$rootScope","$http","$timeout","$uibModal","flowFactory","cfpLoadingBar","$filter","DTOptionsBuilder","DTColumnBuilder","DTColumnDefBuilder",function(e,o,t,a,n,i,r,s,c,l,u,d,f,m,p,v,g){var q=t;if(e.loading=!0,e.isView=c.is("app.cotizaciones.view"),e.isCreate=c.is("app.cotizaciones.create"),e.format="dd-MM-yyyy",e.minDate=new Date-1,e.summary={subTotal:0,expenses:0,tax:0,total:0},e.customers=[],e.quote={id:e.isCreate?0:o.quoteId,customer:null,details:[],expenses:0,tax:0,deadline:new Date,total:0,totalModified:0,observation:"",status:null,responsible:null},e.statusQuote=u.parameters("quote_status"),e.open=function(o){o.preventDefault(),o.stopPropagation(),e.opened=!0},e.dateOptions={formatYear:"yy",startingDay:1},e.quote.id){q.info("editando cliente con código: "+e.quote.id);var w={id:e.quote.id};d({method:"GET",url:"api/quote",params:w})["catch"](function(e,o){if(403==o){var t=null!==e.message&&void 0!==e.message?e.message:"app.asesores.list";l.swal("No Autorizado","No estas autorizado para ver esta información.","error"),f(function(){c.go(t)},3e3)}else 404==o?(l.swal("Información no disponible","Cotización no encontrada","error"),f(function(){c.go("app.cotizaciones.list")})):l.swal("Error","Se ha presentado un error al intentar acceder a la información del cliente","error")}).then(function(o){f(function(){e.quote=o.data.result,C(e.quote.customer.id)})})["finally"](function(){f(function(){h(),e.loading=!1},400)})}else q.info("creacion de nuevo asesor "),e.loading=!1;e.removeImage=function(){e.noImage=!0},e.master=e.quote,e.form={submit:function(o){var t=null;if(o.$invalid){var a=null,t=null;for(a in o)"$"!=a[0]&&(null!==t||o[a].$valid||(t=o[a].$name),o[a].$pristine&&(o[a].$dirty=!0));return q.info(e.quote),angular.element(".ng-invalid[name="+t+"]").focus(),void l.swal("El formulario contiene errores!","Por favor corrige los errores del formulario e Intentalo de nuevo.","error")}l.swal("Validación exitosa","Guardando información del asesor...","success"),q.info(e.quote),y()},reset:function(o){e.quote=angular.copy(e.master),o.$setPristine(!0)}};var y=function(){var o={},a=JSON.stringify(e.quote);return o.data=Base64.encode(a),d({method:"POST",url:"api/quote/save",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(o)}).then(function(e){f(function(){c.go("app.cotizaciones.list")})})["catch"](function(e){t.error(e),l.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})};e.cancelEdition=function(){e.isview?c.go("app.cotizaciones.list"):l.swal({title:"Está seguro?",text:"Perderá todos los cambios realizados en este formulario.",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, cancelar!",cancelButtonText:"No, continuar!",closeOnConfirm:!0,closeOnCancel:!0},function(e){e?f(function(){c.go("app.cotizaciones.list")}):swal("Cancelación","La operación ha sido cancelada","error")})},e.onRemoveDetail=function(o){l.swal({title:"Está seguro?",text:"Eliminará el registro seleccionado",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, eliminar!",cancelButtonText:"No, cancelar!",closeOnConfirm:!0,closeOnCancel:!0},function(t){t?f(function(){e.quote.details.splice(o,1)}):swal("Cancelación","La operación ha sido cancelada","error")})},e.onAddService=function(){if(null==e.quote.service)l.swal("Error","Debe seleccionar el servicio. Por favor verifique! !","error");else{var t=g("filter")(e.quote.details,{serviceId:e.quote.service.id});if(0==t.length){var a={id:0,quoteId:e.isCreate?0:o.quoteId,serviceId:e.quote.service.id,service:e.quote.service,quantity:0,hour:0,total:0,totalModified:0};e.quote.details.push(a)}}},f(function(){h()},10);var h=function(){q.info("editando cliente con código: "+e.quote.id);var o={id:e.quote.id};d({method:"POST",url:"api/quote-service",params:o})["catch"](function(e,o){if(403==o){var t=null!==e.message&&void 0!==e.message?e.message:"app.asesores.list";l.swal("No Autorizado","No estas autorizado para ver esta información.","error"),f(function(){c.go(t)},3e3)}else 404==o?(l.swal("Información no disponible","Cotización no encontrada","error"),f(function(){c.go("app.cotizaciones.list")})):l.swal("Error","Se ha presentado un error al intentar acceder a la información del cliente","error")}).then(function(o){f(function(){e.services=o.data.data})})["finally"](function(){});var o={},a=JSON.stringify(e.customer);return o.data=a,d({method:"POST",url:"api/project/customer",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(o)}).then(function(o){f(function(){e.customers=o.data.data})})["catch"](function(e){t.error(e),l.swal("Error de guardado","Error guardando el registro. Por favor verifique los datos ingresados!","error")})["finally"](function(){})};e.$watch("quote.details",function(){t.info(e.quote.details.length),e.quote.total=0,e.quote.totalModified=0,e.quote.details.length>0&&angular.forEach(e.quote.details,function(o){o.total=o.quantity*o.service.unitValue,e.quote.total+=o.total,e.quote.totalModified+=0==parseFloat(o.totalModified)?o.total:parseFloat(o.totalModified)}),e.summary.subTotal=g("currency")(e.quote.totalModified,"$ ",0),e.summary.expenses=g("currency")(e.quote.expenses,"$ ",0),e.summary.tax=g("currency")(0,"$ ",0),e.summary.total=g("currency")(parseFloat(e.quote.totalModified)+parseFloat(e.quote.expenses),"$ ",0)},!0),e.$watch("quote.expenses",function(){e.summary.subTotal=g("currency")(e.quote.totalModified,"$ ",0),e.summary.expenses=g("currency")(e.quote.expenses,"$ ",0),e.summary.tax=g("currency")(0,"$ ",0),e.summary.total=g("currency")(parseFloat(e.quote.totalModified)+parseFloat(e.quote.expenses),"$ ",0)},!0),e.onCancel=function(){e.isview?c.go("app.cotizaciones.list"):l.swal({title:"Está seguro?",text:"Perderá todos los cambios realizados en este formulario.",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, cancelar!",cancelButtonText:"No, continuar!",closeOnConfirm:!0,closeOnCancel:!0},function(e){e?f(function(){c.go("app.cotizaciones.list")}):swal("Cancelación","La operación ha sido cancelada","error")})},e.onRemoveService=function(o){l.swal({title:"Está seguro?",text:"Eliminará el registro seleccionado",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, eliminar!",cancelButtonText:"No, cancelar!",closeOnConfirm:!0,closeOnCancel:!0},function(a){a?f(function(){var a=e.quote.details[o];if(e.quote.details.splice(o,1),0!=a.id){var n={};n.id=a.id,d({method:"POST",url:"api/quote-service/delete",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(n)}).then(function(e){swal("Eliminado","Registro eliminado satisfactoriamente","info")})["catch"](function(e){t.error(e),l.swal("Error en la eliminación","Se ha presentado un error durante la eliminación del registro. Por favor inténtelo de nuevo, si el error persiste, comuníquese con el administrador del sistema","error")})["finally"](function(){})}}):swal("Cancelación","La operación ha sido cancelada","error")})};var C=function(o){var t={customer_id:o};d({method:"POST",url:"api/quote/responsible",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(t)})["catch"](function(e,o){}).then(function(o){f(function(){e.quote.responsible=o.data.data})})["finally"](function(){})};e.changeCustomer=function(e,o){f(function(){C(e.id)})}}]);